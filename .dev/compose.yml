---
x-backend: &backend
  image: jetthoughts.com-test:1.0.0
  build:
    context: ../
    dockerfile: ./.dev/Dockerfile
  stdin_open: true
  tty: true
  volumes:
    - ..:/app:cached
    - history:/usr/local/hist
  environment:
    HISTFILE: /usr/local/hist/.bash_history
    IRB_HISTFILE: /usr/local/hist/.irb_history
    HUGO_CACHEDIR: /tmp/hugo_cache

services:
  cache-init:
    image: alpine:latest
    volumes:
      - hugo_cache:/tmp/hugo_cache
    command: sh -c "chown -R 1000:1000 /tmp/hugo_cache && chmod -R 755 /tmp/hugo_cache"

  hugo: &hugo
    image: hugomods/hugo:exts-non-root-0.149.1
    stdin_open: true
    tty: true
    volumes:
      - ..:/src:cached
      - hugo_cache:/tmp/hugo_cache
    ports:
      - '1313:1313'
    command: hugo server --bind 0.0.0.0
    environment:
      - HUGO_CACHEDIR=/tmp/hugo_cache
    depends_on:
      - cache-init

  sh:
    <<: *backend
    command: bash

  t-setup:
    <<: *hugo
    command: hugo --minify --environment production --forceSyncStatic --cleanDestinationDir --logLevel warn
    environment:
      - HUGO_CACHEDIR=/tmp/hugo_cache
    depends_on:
      - cache-init

  t:
    <<: *backend
    entrypoint: bin/test
    shm_size: 256mb  # Shared memory size for Chrome browser
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: '2GB'  # Increased for Chrome browser stability
        reservations:
          cpus: '1.5'
          memory: '1GB'  # Increased base reservation

    depends_on:
      t-setup:
        condition: service_completed_successfully
volumes:
  bundle:
  history:
  hugo_cache:
