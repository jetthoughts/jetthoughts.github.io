# Test Format Requirements Reference

**Document ID**: 60.06
**Category**: Testing Standards (Reference)
**Authority**: Project-Specific (extends global `/knowledge/25.04-test-smell-prevention-enforcement-protocols.md`)
**Status**: PRODUCTION READY

---

## 📖 Overview

This document defines the MANDATORY test format requirements for jt_site project. All tests MUST be Ruby/Minitest files validating user-facing behavior. Bash scripts for testing are ABSOLUTELY FORBIDDEN.

**Key Principle**: Tests validate BEHAVIOR (what users see and do), NOT code structure or existence.

---

## 🧪 jt_site Testing Stack

### Framework & Tools
- **Test Framework**: Minitest (NOT RSpec)
- **System Testing**: Capybara with ApplicationSystemTestCase
- **Unit Testing**: ActiveSupport::TestCase
- **Visual Regression**: `assert_stable_screenshot` with ≤3% tolerance
- **Test Runner**: `bin/rake test` or `bin/rake test:critical`

### Why Minitest?
- Standard Ruby testing framework (built into Ruby)
- Simpler, faster, more straightforward than RSpec
- Native Rails integration
- Preferred for jt_site static site testing

---

## ✅ CORRECT Test Formats (REQUIRED)

### 1. System Tests with Capybara (Behavioral Validation)

**Purpose**: Validate user-facing behavior and visual appearance

**Location**: `test/system/components/`

**Example: Button Component Test**
```ruby
# frozen_string_literal: true
# test/system/components/button_test.rb

require "application_system_test_case"

class ButtonTest < ApplicationSystemTestCase
  def test_primary_button_renders_and_is_clickable
    visit "/homepage/"

    # BEHAVIOR VALIDATION: Test what users see and do
    button = find(".c-button--primary")
    assert button.visible?, "Primary button should be visible"

    # INTERACTION: Test user interactions
    button.click
    assert_text "Button clicked"

    # VISUAL VALIDATION: Screenshot comparison (≤3% tolerance)
    assert_stable_screenshot "components/button-primary", tolerance: 0.03
  end

  def test_secondary_button_has_correct_styling
    visit "/homepage/"

    # BEHAVIOR: Validate secondary variant
    button = find(".c-button--secondary")
    assert button.visible?

    # VISUAL: Compare against baseline
    assert_stable_screenshot "components/button-secondary", tolerance: 0.03
  end
end
```

**System Test Characteristics**:
- Inherit from `ApplicationSystemTestCase`
- Use Capybara DSL (`visit`, `find`, `click`, `assert_text`)
- Include visual regression testing (`assert_stable_screenshot`)
- Test complete user workflows
- Validate appearance + behavior together

---

### 2. Unit Tests with Minitest (Helper/Logic Validation)

**Purpose**: Validate helpers, utilities, and isolated logic

**Location**: `test/unit/helpers/`

**Example: Button Helper Test**
```ruby
# frozen_string_literal: true
# test/unit/helpers/button_helper_test.rb

require "test_helper"

class ButtonHelperTest < ActiveSupport::TestCase
  include ButtonHelper

  def test_button_helper_generates_primary_button_markup
    # BEHAVIOR: Test helper output produces correct HTML structure
    result = button_helper("Click me", variant: "primary")

    # VALIDATION: Check behavior outcomes, not implementation
    assert_includes result, "c-button--primary", "Should include primary class"
    assert_includes result, "Click me", "Should include button text"
    assert_includes result, "<button", "Should be a button element"
  end

  def test_button_helper_handles_icon_with_text
    # BEHAVIOR: Test icon + text combination
    result = button_helper("Save", variant: "primary", icon: "save")

    assert_includes result, "c-button--primary"
    assert_includes result, "Save"
    assert_includes result, "icon-save", "Should include icon class"
  end

  def test_button_helper_applies_disabled_state
    # BEHAVIOR: Test disabled button behavior
    result = button_helper("Submit", variant: "primary", disabled: true)

    assert_includes result, "disabled", "Should include disabled attribute"
    assert_includes result, "c-button--disabled", "Should include disabled class"
  end
end
```

**Unit Test Characteristics**:
- Inherit from `ActiveSupport::TestCase`
- Test isolated helper methods or utility functions
- Focus on output correctness, not implementation
- No browser interaction needed
- Fast execution

---

### 3. CSS Component Tests (BEM Validation)

**Purpose**: Validate CSS component structure and visual appearance

**Location**: `test/system/css/`

**Example: CSS Button Component Test**
```ruby
# frozen_string_literal: true
# test/system/css/button_component_test.rb

require "application_system_test_case"

class ButtonComponentTest < ApplicationSystemTestCase
  def test_button_block_modifier_applies_full_width
    visit "/components-showcase/"

    # BEHAVIOR: Block modifier makes button full width
    button = find(".c-button--block")
    assert button.visible?

    # VISUAL: Validate full-width appearance
    assert_stable_screenshot "css/button-block", tolerance: 0.03
  end

  def test_button_size_variants_render_correctly
    visit "/components-showcase/"

    # BEHAVIOR: All size variants exist and are visible
    assert find(".c-button--small").visible?
    assert find(".c-button--medium").visible?
    assert find(".c-button--large").visible?

    # VISUAL: Compare all size variants
    assert_stable_screenshot "css/button-sizes", tolerance: 0.03
  end
end
```

**CSS Test Characteristics**:
- Validate BEM component structure
- Test CSS modifiers and variants
- Include visual regression testing
- Focus on user-facing appearance

---

## ❌ FORBIDDEN Test Formats (ZERO TOLERANCE)

### 1. Bash Test Scripts (ABSOLUTELY FORBIDDEN)

**Why Forbidden**:
- ❌ Tests code existence, not behavior
- ❌ Not run by test framework (`bin/rake test`)
- ❌ Not integrated with CI/CD
- ❌ Not measuring user-facing outcomes
- ❌ Not providing test coverage metrics
- ❌ Cannot run visual regression tests

**FORBIDDEN Example**:
```bash
# ❌ FORBIDDEN - DO NOT CREATE
#!/bin/bash
# test/test_button_component.sh

test_button_component_exists() {
    if grep -q ".c-button" themes/beaver/assets/css/components/button.css; then
        echo "✅ Button component exists"
        return 0
    else
        echo "❌ Button component missing"
        return 1
    fi
}

# This is CODE EXISTENCE CHECKING, not BEHAVIOR TESTING
```

**Why This Is Wrong**:
- Only checks if code exists, not if it works
- Doesn't validate what users see
- Doesn't test button actually renders
- Doesn't test button can be clicked
- Doesn't compare visual appearance
- Breaks when CSS is refactored (even if behavior is unchanged)

---

### 2. Shell Script Validation (FORBIDDEN FOR TESTS)

**FORBIDDEN Example**:
```bash
# ❌ FORBIDDEN - This is automation, not testing
validate_css_changes() {
    # Only checks code structure, not behavior
    find themes/beaver/assets/css -name "*.css" -exec grep -l ".c-button" {} \;
}
```

**Why This Is Wrong**:
- File finding is not behavior testing
- Doesn't validate user experience
- Cannot be integrated with test framework
- No visual regression capability

---

### 3. JavaScript-Based Existence Checks (FORBIDDEN)

**FORBIDDEN Example**:
```javascript
// ❌ FORBIDDEN - Existence checking, not behavior testing
const fs = require('fs');

function testButtonComponentExists() {
  const css = fs.readFileSync('themes/beaver/assets/css/components/button.css', 'utf8');
  return css.includes('.c-button') ? 'PASS' : 'FAIL';
}
```

**Why This Is Wrong**:
- Same issues as bash scripts
- Checks code structure, not user-facing behavior
- No browser rendering validation
- No visual regression testing

---

## 🎯 When to Use What

### Ruby/Minitest System Tests (PRIMARY - 70% of tests)

**Use for**:
- ✅ User-facing behavior validation
- ✅ Visual regression testing (screenshot comparison)
- ✅ Component rendering validation
- ✅ User interaction testing (clicks, hovers, forms)
- ✅ Mobile responsiveness validation
- ✅ Cross-browser compatibility testing
- ✅ Accessibility validation (ARIA, keyboard navigation)
- ✅ Complete user workflows (multi-step interactions)

**Run with**: `bin/rake test:system` or `bin/rake test:critical`

**Characteristics**:
- Full browser environment (Capybara)
- Slow but comprehensive
- High confidence in user experience
- Visual screenshot comparison

---

### Ruby/Minitest Unit Tests (SECONDARY - 30% of tests)

**Use for**:
- ✅ Helper method validation
- ✅ Utility function testing
- ✅ Data transformation logic
- ✅ Edge case validation
- ✅ Isolated component logic

**Run with**: `bin/rake test:units`

**Characteristics**:
- Fast execution
- No browser needed
- Isolated testing
- Lower-level validation

---

### Bash Scripts (ONLY for Automation - NEVER for Testing)

**Use for** (NOT testing):
- Build automation (Hugo builds)
- Deployment scripts
- Git operations (commits, pushes)
- File management (cleanup, organization)
- CI/CD orchestration
- Development environment setup

**Examples**:
```bash
# ✅ CORRECT - Build automation
bin/build_site.sh

# ✅ CORRECT - Deployment automation
bin/deploy_to_production.sh

# ✅ CORRECT - Development setup
bin/setup_dev_environment.sh
```

**Critical**: Bash scripts are for AUTOMATION, NEVER for TESTING. If it validates behavior, it must be a Minitest test.

---

## 🚨 Agent Behavioral Constraints

### Decision Protocol for Test Creation

**MANDATORY Question**: "Am I testing BEHAVIOR or code existence?"

**Decision Tree**:
```yaml
test_creation_decision:
  question_1: "What am I validating?"
    answer_behavior: "User sees button, button is clickable, button looks correct"
      action: "✅ Create Minitest system test with Capybara"
      location: "test/system/components/{component}_test.rb"

    answer_code_existence: "Button CSS class exists in file"
      action: "❌ STOP - This is not a test, this is code checking"
      alternative: "Create behavioral test that validates button renders and works"

    answer_configuration: "Config value is set correctly"
      action: "❌ STOP - Configuration testing is usually forbidden"
      alternative: "Test business behavior affected by configuration"

  question_2: "Can this test catch real user-facing bugs?"
    answer_yes: "✅ Create Minitest test"
    answer_no: "❌ STOP - This is not a useful test"

  question_3: "Will this test stay green when I refactor working code?"
    answer_yes: "✅ Test is behavior-focused (GOOD)"
    answer_no: "❌ Test is implementation-coupled (BAD)"
```

---

### Test File Naming & Location Protocol

**System Tests** (Capybara):
```yaml
naming_convention:
  pattern: "{component}_test.rb"
  location: "test/system/components/"
  class_name: "{Component}Test"
  inheritance: "ApplicationSystemTestCase"

examples:
  button: "test/system/components/button_test.rb → ButtonTest"
  card: "test/system/components/card_test.rb → CardTest"
  navigation: "test/system/components/navigation_test.rb → NavigationTest"
```

**Unit Tests** (Minitest):
```yaml
naming_convention:
  pattern: "{helper_name}_helper_test.rb"
  location: "test/unit/helpers/"
  class_name: "{HelperName}HelperTest"
  inheritance: "ActiveSupport::TestCase"

examples:
  button_helper: "test/unit/helpers/button_helper_test.rb → ButtonHelperTest"
  card_helper: "test/unit/helpers/card_helper_test.rb → CardHelperTest"
```

**FORBIDDEN Patterns**:
```yaml
never_create:
  - "test/test_*.sh"
  - "test/*_test.sh"
  - "bin/test_*.sh"
  - "bin/validate_*.sh"
  - "scripts/test_*.sh"
  - Any .sh file in test/ directory
```

---

### Automatic Violation Detection

**Agents MUST reject these requests**:

1. ❌ "Create a bash script to test if button CSS exists"
   - **Rejection**: "I cannot create bash test scripts. I'll create a Minitest system test that validates button behavior."

2. ❌ "Write a shell script to validate component structure"
   - **Rejection**: "Shell scripts are for automation, not testing. I'll create a Minitest test validating component behavior."

3. ❌ "Create test_button.sh to check button class"
   - **Rejection**: "Bash scripts cannot test user-facing behavior. I'll create test/system/components/button_test.rb with Capybara validation."

4. ❌ "Add grep command to verify CSS exists"
   - **Rejection**: "Code existence checking is not testing. I'll create a behavioral test that validates button renders and works correctly."

**Agents MUST create instead**:
- ✅ Ruby test files (`*_test.rb`)
- ✅ System tests in `test/system/`
- ✅ Unit tests in `test/unit/`
- ✅ Tests using Capybara (system) or Minitest (unit)
- ✅ Tests validating user-facing behavior

---

## 🔄 Test Development Workflow (TDD)

### RED Phase (Write Failing Test)
```ruby
# 1. Write test describing desired behavior (test fails because feature doesn't exist)
def test_primary_button_renders_with_correct_styling
  visit "/homepage/"
  button = find(".c-button--primary")
  assert button.visible?
  assert_stable_screenshot "button-primary", tolerance: 0.03
end

# Run: bin/rake test:critical
# Expected: Test fails (button doesn't exist yet)
```

### GREEN Phase (Make Test Pass)
```css
/* 2. Implement minimal CSS to make test pass */
.c-button--primary {
  display: inline-block;
  padding: 12px 24px;
  background-color: #0066cc;
  color: white;
  border: none;
  border-radius: 4px;
}

# Run: bin/rake test:critical
# Expected: Test passes (hardcoded implementation acceptable)
```

### REFACTOR Phase (Improve Code)
```css
/* 3. Apply flocking rules to improve CSS organization */
.c-button {
  display: inline-block;
  padding: var(--button-padding-default);
  border: none;
  border-radius: var(--button-border-radius);
}

.c-button--primary {
  background-color: var(--color-primary);
  color: var(--color-on-primary);
}

# Run: bin/rake test:critical after each refactoring micro-step
# Expected: All tests remain green
```

---

## 📊 Test Quality Standards

### Coverage Targets
- **System Tests**: ≥70% of test suite
- **Unit Tests**: ≥30% of test suite
- **Overall Coverage**: ≥95% statements, ≥90% branches
- **Visual Regression**: All visual components must have screenshot tests

### Test Quality Metrics
- **Execution Speed**: System tests <5s each, Unit tests <100ms each
- **Visual Tolerance**: ≤3% difference for screenshot comparison
- **Failure Rate**: <1% false positives from visual tests
- **Maintenance**: Tests should not require updates during code refactoring

### Anti-Test-Smell Compliance
All tests MUST comply with `/knowledge/25.04-test-smell-prevention-enforcement-protocols.md`:
- ✅ Behavior-focused (not implementation-focused)
- ✅ No existence testing
- ✅ No configuration testing (usually)
- ✅ No redundant testing
- ✅ Fast, Isolated, Repeatable, Self-validating, Timely (FIRST principles)

---

## 🔍 Common Test Scenarios

### Testing CSS Component Addition
```ruby
# CORRECT: Behavioral validation
def test_new_card_component_renders_with_image_and_text
  visit "/components-showcase/"

  card = find(".c-card")
  assert card.visible?

  # Validate card contains expected elements
  within(card) do
    assert find(".c-card__image").visible?
    assert find(".c-card__title").visible?
    assert_text "Card Title"
  end

  # Visual validation
  assert_stable_screenshot "components/card-default", tolerance: 0.03
end

# WRONG: Existence checking (FORBIDDEN)
# grep -q ".c-card" themes/beaver/assets/css/components/card.css
```

### Testing CSS Modifier Addition
```ruby
# CORRECT: Behavioral validation
def test_button_block_modifier_applies_full_width
  visit "/components-showcase/"

  block_button = find(".c-button--block")
  assert block_button.visible?

  # Validate full-width behavior
  button_width = block_button.evaluate_script("this.offsetWidth")
  container_width = block_button.evaluate_script("this.parentElement.offsetWidth")
  assert_equal container_width, button_width, "Block button should span full container width"

  # Visual validation
  assert_stable_screenshot "components/button-block", tolerance: 0.03
end
```

### Testing Responsive Behavior
```ruby
# CORRECT: Multi-viewport behavioral validation
def test_navigation_collapses_on_mobile
  # Desktop viewport
  resize_window_to(1200, 800)
  visit "/homepage/"
  assert find(".c-nav__menu").visible?
  refute find(".c-nav__toggle").visible?

  # Mobile viewport
  resize_window_to(375, 667)
  visit "/homepage/"
  refute find(".c-nav__menu").visible?
  assert find(".c-nav__toggle").visible?

  # Interaction test
  find(".c-nav__toggle").click
  assert find(".c-nav__menu").visible?

  # Visual validation
  assert_stable_screenshot "navigation/mobile-collapsed", tolerance: 0.03
end
```

---

## 🚀 Running Tests

### Quick Commands
```bash
# Run all tests
bin/rake test

# Run critical tests only (faster subset)
bin/rake test:critical

# Run system tests only
bin/rake test:system

# Run unit tests only
bin/rake test:units

# Run specific test file
bin/rake test TEST=test/system/components/button_test.rb

# Run specific test method
bin/rake test TEST=test/system/components/button_test.rb TESTOPTS="--name=test_primary_button_renders_correctly"

# Run with verbose output
bin/rake test TESTOPTS="--verbose"
```

### CI/CD Integration
Tests automatically run via CI/CD pipeline on:
- Every commit to feature branches
- Pull request creation/update
- Merge to main branch

**CI Configuration**: `.github/workflows/test.yml` (if using GitHub Actions)

---

## 📖 References

### Global Standards (SUPREME AUTHORITY)
- `/knowledge/25.04-test-smell-prevention-enforcement-protocols.md` - Test quality enforcement
- `/knowledge/20.01-tdd-methodology-reference.md` - TDD standards
- `/knowledge/20.02-four-eyes-principle-global.md` - Validation protocols

### Project-Specific Documentation
- `docs/60.03-tdd-quality-enforcement.md` - jt_site TDD practices
- `docs/visual_testing_delegation_workflows.md` - Visual testing workflows
- `docs/projects/2509-css-migration/50-59-testing/SPRINT-3-TDD-TESTING-STRATEGY.md` - Sprint 3 TDD strategy

### External Documentation
- **Minitest**: https://docs.seattlerb.org/minitest/
- **Capybara**: https://teamcapybara.github.io/capybara/
- **Rails Testing**: https://guides.rubyonrails.org/testing.html

---

**Document Owner**: jt_site Testing Team
**Last Updated**: September 30, 2025
**Version**: 1.0
**Status**: PRODUCTION READY