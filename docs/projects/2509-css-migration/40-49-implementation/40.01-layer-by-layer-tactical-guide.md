# Layer-by-Layer Tactical Execution Guide
**Project**: jt_site CSS TOP-DOWN Consolidation
**Purpose**: Step-by-step tactical instructions for CSS Migration Team
**Reference**: top-down-consolidation-strategy.md (Strategic overview)

---

## üéØ WEEK 1 TACTICAL EXECUTION: LAYER 0 + LAYER 1

### **TASK 1.1: Layer 0 Audit (CSS Variables)**
**Duration**: 2 hours | **Risk**: LOW | **Files**: 1-3

```yaml
objective: "Validate foundations/css-variables.css as single source of truth for :root variables"

steps:
  1_search_for_root_blocks:
    command: "grep -rn ':root {' themes/beaver/assets/css/ --include='*.css'"
    expected: "Should find ONLY foundations/css-variables.css"
    action_if_duplicates: "Move inline :root blocks to foundations/css-variables.css"

  2_search_for_css_variables:
    command: "grep -rn 'var(--' themes/beaver/assets/css/ --include='*.css' | cut -d: -f1 | sort -u"
    expected: "List ALL files using CSS custom properties"
    action: "Document CSS variable usage patterns"

  3_validate_variable_definitions:
    file: "themes/beaver/assets/css/foundations/css-variables.css"
    current_state: "9 lines - defines --font-system-ui only"
    action: "Check if other variables needed (colors, spacing, breakpoints)"

  4_create_comprehensive_variables:
    if_needed: "Expand foundations/css-variables.css with additional tokens"
    patterns:
      - "--color-primary, --color-secondary (if used)"
      - "--spacing-unit (if spacing scales exist)"
      - "--breakpoint-mobile, --breakpoint-tablet (if responsive vars exist)"

validation_protocol:
  - "Run: bin/rake test:critical (expect 0 failures)"
  - "No visual changes expected (variables only affect computed values)"
  - "Commit: 'refactor(css): audit Layer 0 CSS variables foundation'"

memory_storage:
  - "hugo/css/layer-0/audit-results/20251014"
  - "Document: Which files use CSS variables, which variables defined"
```

---

### **TASK 1.2: Layer 1 Foundation Consolidation (CRITICAL)**
**Duration**: 1 day | **Risk**: LOW-MODERATE | **Files**: 8

```yaml
objective: "Create single authoritative critical/base-foundation.css merging ALL foundation patterns"

step_1_create_base_foundation_file:
  action: "Create themes/beaver/assets/css/critical/base-foundation.css"
  content_sections:
    section_1_css_variables_import:
      - "@import '../foundations/css-variables.css';"
      - "/* Load CSS custom properties FIRST */"

    section_2_box_sizing_reset:
      source: "utilities/foundation/reset.css (lines 6-11)"
      pattern: |
        /* Box-sizing Reset - Universal */
        .fl-builder-content *, .fl-builder-content *:before, .fl-builder-content *:after {
          -webkit-box-sizing: border-box;
          -moz-box-sizing: border-box;
          box-sizing: border-box;
        }

    section_3_clearfix_patterns:
      source_1: "utilities/clearfix.css (pp-clearfix)"
      source_2: "utilities/fl-builder-grid.css (FL-Builder clearfix)"
      pattern: |
        /* Clearfix Utility Patterns */
        .pp-clearfix:before, .pp-clearfix:after,
        .fl-row:before, .fl-row:after,
        .fl-row-content:before, .fl-row-content:after,
        .fl-col-group:before, .fl-col-group:after,
        .fl-col:before, .fl-col:after,
        .fl-module:before, .fl-module:after,
        .fl-module-content:before, .fl-module-content:after {
          display: table;
          content: " ";
        }

        .pp-clearfix:after,
        .fl-row:after,
        .fl-row-content:after,
        .fl-col-group:after,
        .fl-col:after,
        .fl-module:after,
        .fl-module-content:after {
          clear: both;
        }

    section_4_screen_reader_utility:
      source: "utilities/foundation/screen-reader.css"
      pattern: |
        /* Screen Reader Only Utility */
        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border: 0;
        }

    section_5_base_reset:
      source: "critical/base-reset.css"
      pattern: |
        /* Base Critical Reset - FL-Builder Row Content */
        .fl-row-content-wrap {
          margin-top: 0;
          margin-right: 0;
          margin-bottom: 0;
          margin-left: 0;
        }

  expected_file_size: "~60 lines (well-commented)"
  validation: "Syntax check, no visual impact yet"

step_2_update_critical_css_partials:
  action: "Update ALL critical CSS partials to @import base-foundation.css"
  files_to_update:
    - "themes/beaver/layouts/partials/header/critical/base-critical.html"
    - "themes/beaver/layouts/partials/header/critical/homepage-critical.html"
    - "themes/beaver/layouts/partials/header/critical/about-us-critical.html"
    - "themes/beaver/layouts/partials/header/critical/services-critical.html"
    - "themes/beaver/layouts/partials/header/critical/use-cases-critical.html"
    - "themes/beaver/layouts/partials/header/critical/careers-critical.html"
    - "themes/beaver/layouts/partials/header/critical/clients-critical.html"
    - "themes/beaver/layouts/partials/header/critical/free-consultation-critical.html"
    - "themes/beaver/layouts/partials/header/critical/privacy-policy-critical.html"

  import_pattern: |
    <style>
    @import url('/css/critical/base-foundation.css');
    /* ... rest of critical CSS ... */
    </style>

  validation:
    - "Verify @import loads correctly in browser (check Network tab)"
    - "Verify box-sizing applies to .fl-builder-content elements"
    - "Run: bin/rake test:critical (expect 0 failures)"

step_3_create_404_critical_infrastructure:
  action: "Create themes/beaver/layouts/partials/header/critical/404-critical.html"
  content: |
    <style>
    @import url('/css/critical/base-foundation.css');
    /* 404 Page Critical CSS */
    /* Additional 404-specific critical styles here */
    </style>

  update_404_template:
    file: "themes/beaver/layouts/404.html"
    add_partial: "{{ partial \"header/critical/404-critical.html\" . }}"

  validation:
    - "Navigate to /404.html"
    - "Verify base-foundation.css loads via Network tab"
    - "Capture baseline screenshot for 404 page"

step_4_create_blog_critical_infrastructure:
  action: "Create themes/beaver/layouts/partials/header/critical/blog-critical.html"
  content: |
    <style>
    @import url('/css/critical/base-foundation.css');
    /* Blog List Page Critical CSS */
    /* Additional blog-specific critical styles here */
    </style>

  update_blog_template:
    file: "themes/beaver/layouts/_default/list.html"
    add_partial: "{{ partial \"header/critical/blog-critical.html\" . }}"

  validation:
    - "Navigate to /blog/"
    - "Verify base-foundation.css loads via Network tab"
    - "Capture baseline screenshot for blog list page"

step_5_remove_foundation_duplicates:
  action: "Remove foundation pattern duplicates from numbered layouts"
  files_to_update:
    - "themes/beaver/assets/css/2949-layout.css (lines 3-40)"
    - "themes/beaver/assets/css/3021-layout.css (lines 3-40)"
    - "themes/beaver/assets/css/3027-layout.css (lines 3-40)"
    - "themes/beaver/assets/css/3059-layout.css (lines 3-40)"
    - "themes/beaver/assets/css/3082-layout.css (lines 3-40)"
    - "themes/beaver/assets/css/3086-layout2.css (lines 3-40)"
    - "[ALL other numbered layouts with foundation duplicates]"

  patterns_to_remove:
    - "box-sizing reset (.fl-builder-content *)"
    - "clearfix patterns (.fl-row:before, .fl-clearfix:after)"
    - "screen-reader utility (.sr-only)"

  micro_commit_strategy:
    - "Process ONE file at a time"
    - "Remove foundation duplicates"
    - "Test with: bin/rake test:critical"
    - "Capture screenshot, compare with baseline (tolerance: 0.0)"
    - "Commit: 'refactor(css): remove Layer 1 duplicates from [filename]'"
    - "If visual regression detected: STOP, rollback, investigate"

validation_protocol:
  pre_consolidation:
    - "Capture baseline screenshots for ALL pages affected"
    - "Document line ranges to remove per file"

  post_consolidation:
    - "Screenshot comparison: tolerance: 0.0"
    - "Verify box-sizing applies correctly (inspect element)"
    - "Verify clearfix works on grid layouts"
    - "Run: bin/rake test:critical (expect 0 failures)"

  four_eyes_approval:
    - "Coder: Foundation duplicates removed ‚úì"
    - "Reviewer: Pattern compliance validated ‚úì"
    - "Screenshot Guardian: 0% visual difference validated ‚úì"
    - "Tester: Tests pass, baselines preserved ‚úì"

memory_storage:
  - "hugo/css/layer-1/consolidation-results/20251014"
  - "Document: Files updated, duplicates removed, screenshot comparisons"

expected_impact:
  duplicates_removed: "60+ foundation rule sets"
  file_size_reduction: "~60KB total"
  visual_changes: "ZERO (tolerance: 0.0)"
```

---

## üéØ WEEK 2 TACTICAL EXECUTION: LAYER 2 + LAYER 4

### **TASK 2.1: Layer 2 Utility Consolidation**
**Duration**: 2 days | **Risk**: LOW | **Files**: 25

```yaml
objective: "Validate utilities/ directory organization, eliminate inline utility duplicates"

step_1_audit_utilities_directory:
  command: "ls -lh themes/beaver/assets/css/utilities/"
  action: "Document current utility file organization"
  check_for_overlaps:
    - "Do margins.css and padding.css have clear separation?"
    - "Do display.css and flexbox.css overlap?"
    - "Are responsive utilities split logically (visibility vs breakpoints)?"

step_2_validate_consolidated_utilities_master:
  file: "themes/beaver/assets/css/utilities/_consolidated-utilities.css"
  action: "Verify ALL utility files imported via @import statements"
  expected: |
    @import 'foundation/reset.css';           /* Now in base-foundation.css - can remove */
    @import 'clearfix.css';                   /* Now in base-foundation.css - can remove */
    @import 'margins.css';                    /* Keep */
    @import 'padding.css';                    /* Keep */
    @import 'display.css';                    /* Keep */
    @import 'flexbox.css';                    /* Keep */
    /* ... etc ... */

  cleanup_action: "Remove imports now handled by base-foundation.css"

step_3_search_for_inline_utilities:
  command: |
    grep -rn '\.m-auto\|\.m-0\|\.d-none\|\.d-block' themes/beaver/assets/css/*-layout.css
  expected: "Find inline utility definitions in numbered layouts"
  action: "Document which pages have inline utilities to remove"

step_4_remove_inline_utilities:
  micro_commit_strategy:
    - "Process ONE page file at a time"
    - "Remove inline .m-*, .p-*, .d-* utility definitions"
    - "Verify page loads _consolidated-utilities.css"
    - "Test with: bin/rake test:critical"
    - "Commit: 'refactor(css): remove Layer 2 utility duplicates from [filename]'"

validation_protocol:
  - "Screenshot comparison: tolerance: 0.0"
  - "Verify utility classes apply correctly (inspect element)"
  - "Run: bin/rake test:critical (expect 0 failures)"

memory_storage:
  - "hugo/css/layer-2/consolidation-results/20251014"
```

---

### **TASK 2.2: Layer 4 Layout/Grid Consolidation (CRITICAL)**
**Duration**: 2 days | **Risk**: HIGH | **Files**: 15

```yaml
objective: "Establish utilities/fl-builder-grid.css as authoritative, remove ALL duplicates"

step_1_validate_fl_builder_grid_completeness:
  file: "themes/beaver/assets/css/utilities/fl-builder-grid.css"
  check_patterns:
    - "FL-Builder clearfix (.fl-row:before, .fl-row:after)"
    - "FL-Builder grid (.fl-row, .fl-col, .fl-col-group)"
    - "Equal-height columns (.fl-col-group-equal-height)"
    - "Responsive grid patterns"
  action: "Ensure ALL FL-Builder grid patterns present"

step_2_update_critical_css_for_grid:
  action: "Update critical CSS partials to @import fl-builder-grid.css"
  files:
    - "themes/beaver/layouts/partials/header/critical/base-critical.html"
    - "themes/beaver/layouts/partials/header/critical/404-critical.html"
    - "themes/beaver/layouts/partials/header/critical/blog-critical.html"
    - "[ALL other critical CSS partials]"

  import_pattern: |
    <style>
    @import url('/css/critical/base-foundation.css');
    @import url('/css/utilities/fl-builder-grid.css');  /* Add this */
    /* ... rest of critical CSS ... */
    </style>

step_3_remove_fl_builder_grid_duplicates:
  high_risk_warning: "‚ö†Ô∏è GRID CHANGES AFFECT LAYOUT STRUCTURE - SCREENSHOT VALIDATION MANDATORY"

  files_to_update:
    - "themes/beaver/assets/css/2949-layout.css (lines 9-100)"
    - "themes/beaver/assets/css/3021-layout.css (lines 9-100)"
    - "themes/beaver/assets/css/3027-layout.css (lines 9-100)"
    - "themes/beaver/assets/css/3082-layout.css (lines 9-100)"
    - "themes/beaver/assets/css/3086-layout2.css (lines 9-100)"
    - "[ALL numbered layouts with FL-Builder grid duplicates]"

  patterns_to_remove:
    - ".fl-row:before, .fl-row:after (clearfix - now in base-foundation.css)"
    - ".fl-row, .fl-row-content (grid base)"
    - ".fl-col-group (column groups)"
    - ".fl-col-group-equal-height (equal-height layout)"

  micro_commit_strategy:
    - "‚ö†Ô∏è MANDATORY: Capture baseline screenshot BEFORE touching file"
    - "Process ONE page file at a time"
    - "Remove FL-Builder grid duplicates (lines 9-100)"
    - "Test with: bin/rake test:critical"
    - "‚ö†Ô∏è MANDATORY: Compare screenshots with tolerance: 0.0"
    - "‚ö†Ô∏è BLOCKING: Screenshot Guardian MUST approve BEFORE commit"
    - "Commit: 'refactor(css): remove Layer 4 FL-Builder grid duplicates from [filename]'"
    - "‚ö†Ô∏è ROLLBACK: If ANY visual regression detected, rollback immediately"

validation_protocol:
  pre_consolidation:
    - "‚ö†Ô∏è MANDATORY: Capture baseline screenshots for ALL pages"
    - "Document FL-Builder grid usage patterns per page"
    - "Test equal-height columns, flex layouts, grid alignment"

  post_consolidation:
    - "‚ö†Ô∏è MANDATORY: Screenshot comparison tolerance: 0.0 (ZERO tolerance)"
    - "‚ö†Ô∏è MANDATORY: Screenshot Guardian ABSOLUTE blocking authority"
    - "Test grid responsiveness at ALL breakpoints (mobile, tablet, desktop)"
    - "Verify equal-height columns work correctly"
    - "Verify flex layouts maintain structure"
    - "Run: bin/rake test:critical (expect 0 failures)"

  four_eyes_approval_required:
    - "Coder: FL-Builder grid duplicates removed ‚úì"
    - "Reviewer: Grid pattern compliance validated ‚úì"
    - "‚ö†Ô∏è Screenshot Guardian: 0% visual difference validated ‚úì (BLOCKING)"
    - "Tester: Tests pass, layout integrity preserved ‚úì"

blocklist_enforcement:
  files_not_to_touch:
    - "404.css (process ONLY AFTER 404-critical.html created)"
    - "3114-layout.css (process ONLY AFTER blog-critical.html created)"

  reason: "These files previously caused 9.5% desktop / 15.4% mobile visual regression"

memory_storage:
  - "hugo/css/layer-4/consolidation-results/20251014"
  - "Document: Files updated, grid duplicates removed, screenshot validations"

expected_impact:
  duplicates_removed: "60+ FL-Builder grid rule sets"
  file_size_reduction: "~80KB total"
  visual_risk: "HIGH - grid changes affect layout structure"
```

---

## üéØ WEEK 3 TACTICAL EXECUTION: LAYER 3

### **TASK 3.1: Layer 3 Component Consolidation**
**Duration**: 3 days | **Risk**: MODERATE | **Files**: 30

```yaml
objective: "Consolidate component pairs (base vs BEM vs migration), eliminate duplicates"

step_1_identify_component_pairs:
  patterns:
    buttons:
      - "components/buttons.css (base)"
      - "components/c-button.css (BEM)"
      - "components/buttons-migration.css (migration)"
      - "components/c-pp-buttons.css (PowerPack)"

    navigation:
      - "components/navigation.css (base)"
      - "components/c-navigation.css (BEM)"
      - "components/navigation-migration.css (migration)"

    forms:
      - "components/forms.css (base)"
      - "components/c-gravity-forms.css (Gravity Forms)"
      - "components/forms-migration.css (migration)"

  action: "Analyze each component group for overlaps and migration opportunities"

step_2_merge_migration_css:
  example_button_consolidation:
    source_files:
      - "components/buttons.css (base styles)"
      - "components/buttons-migration.css (migration fixes)"

    target_file: "components/buttons.css (merged)"

    merge_strategy:
      - "Copy migration fixes from buttons-migration.css"
      - "Append to buttons.css with clear section headers"
      - "Delete buttons-migration.css"
      - "Update _consolidated-components.css imports"

  micro_commit_strategy:
    - "Process ONE component type at a time (buttons ‚Üí navigation ‚Üí forms)"
    - "Merge migration CSS into base component file"
    - "Test component functionality (click buttons, submit forms, navigate menus)"
    - "Capture screenshots of pages using component"
    - "Commit: 'refactor(css): merge [component]-migration.css into [component].css'"

validation_protocol:
  - "Screenshot comparison: tolerance: 0.01 (allow minor rendering differences)"
  - "Test component interactivity (buttons clickable, forms submittable)"
  - "Verify responsive behavior at all breakpoints"
  - "Run: bin/rake test:critical (expect 0 failures)"

memory_storage:
  - "hugo/css/layer-3/consolidation-results/20251014"
```

---

## üéØ WEEK 4-6 TACTICAL EXECUTION: LAYER 5 (PAGE-SPECIFIC)

### **TASK 5.1: Layer 5 Page-Specific Consolidation (HIGHEST RISK)**
**Duration**: 2-3 weeks | **Risk**: HIGH | **Files**: 50+

```yaml
objective: "Strip duplicates from page-specific files, preserve .fl-node-* selectors"

critical_warning: |
  ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è HIGHEST RISK LAYER - PREVIOUS FAILURES OCCURRED HERE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
  - Process ONE page at a time
  - Process ONE layer at a time (foundation ‚Üí grid ‚Üí utilities ‚Üí components)
  - Commit after EACH layer removal
  - Screenshot Guardian has ABSOLUTE blocking authority
  - Tolerance: 0.0 (ZERO tolerance for visual changes)
  - Rollback IMMEDIATELY if visual regression detected

page_processing_phases:
  phase_1_foundation_removal:
    files: "All numbered layouts (2949, 3021, 3027, etc.)"
    patterns_to_remove:
      - "box-sizing reset (lines 3-7)"
      - "clearfix patterns (lines 9-29)"
      - "screen-reader utility (lines 31-40)"

    micro_commit_protocol:
      step_1: "Capture baseline screenshot for page"
      step_2: "Remove foundation duplicates (lines 1-40)"
      step_3: "Verify page loads base-foundation.css"
      step_4: "Test: bin/rake test:critical"
      step_5: "Compare screenshots (tolerance: 0.0)"
      step_6: "Screenshot Guardian approval REQUIRED"
      step_7: "Commit: 'refactor(css): remove Layer 1 foundation duplicates from [page]'"
      step_8: "If visual regression: ROLLBACK, do NOT proceed"

  phase_2_grid_removal:
    files: "All numbered layouts (2949, 3021, 3027, etc.)"
    patterns_to_remove:
      - "FL-Builder grid (.fl-row, .fl-col, .fl-col-group) (lines 41-100)"
      - "Equal-height columns (.fl-col-group-equal-height)"

    micro_commit_protocol:
      step_1: "Capture baseline screenshot for page (after Phase 1)"
      step_2: "Remove FL-Builder grid duplicates (lines 41-100)"
      step_3: "Verify page loads fl-builder-grid.css"
      step_4: "Test: bin/rake test:critical"
      step_5: "Compare screenshots (tolerance: 0.0)"
      step_6: "‚ö†Ô∏è Test grid responsiveness at ALL breakpoints"
      step_7: "Screenshot Guardian approval REQUIRED (BLOCKING)"
      step_8: "Commit: 'refactor(css): remove Layer 4 FL-Builder grid duplicates from [page]'"
      step_9: "If visual regression: ROLLBACK, do NOT proceed"

  phase_3_utility_removal:
    files: "Numbered layouts with inline utilities"
    patterns_to_remove:
      - "Margin utilities (.m-auto, .m-0, .m-t-10)"
      - "Padding utilities (.p-*)"
      - "Display utilities (.d-none, .d-block)"

    micro_commit_protocol:
      step_1: "Capture baseline screenshot for page (after Phase 2)"
      step_2: "Remove utility class duplicates (lines 101-200)"
      step_3: "Verify page loads _consolidated-utilities.css"
      step_4: "Test: bin/rake test:critical"
      step_5: "Compare screenshots (tolerance: 0.0)"
      step_6: "Screenshot Guardian approval REQUIRED"
      step_7: "Commit: 'refactor(css): remove Layer 2 utility duplicates from [page]'"

  phase_4_component_evaluation:
    files: "Numbered layouts with component overrides"
    action: "EVALUATE - distinguish global fixes vs page-specific overrides"

    evaluation_criteria:
      global_component_fix:
        indicators:
          - "Applies to ALL instances of component across site"
          - "Fixes bug or improves component base behavior"
          - "No .fl-node-* selectors involved"
        action: "Move to component file (e.g., components/buttons.css)"

      page_specific_override:
        indicators:
          - "Applies ONLY to this page's component instances"
          - "Uses .fl-node-* selectors"
          - "Customizes component for specific layout"
        action: "PRESERVE in page-specific file"

    micro_commit_protocol:
      step_1: "Analyze component overrides (lines 201-500)"
      step_2: "Identify global fixes, move to component files"
      step_3: "Preserve page-specific overrides with .fl-node-*"
      step_4: "Test: bin/rake test:critical"
      step_5: "Compare screenshots (tolerance: 0.0)"
      step_6: "Commit: 'refactor(css): consolidate component overrides from [page]'"

  phase_5_page_specific_preservation:
    files: "All page-specific files"
    action: "Validate ALL .fl-node-* selectors preserved, document layout-critical CSS"

    validation_checklist:
      - "‚úì ALL .fl-node-* selectors present and unchanged"
      - "‚úì Layout-critical CSS identified and documented"
      - "‚úì Page file contains ONLY page-specific CSS"
      - "‚úì Foundation/grid/utility/component duplicates removed"
      - "‚úì Screenshot comparison shows 0% difference"

sample_file_processing_workflow:
  target_file: "themes/beaver/assets/css/2949-layout.css"

  original_structure:
    - "Lines 1-2: @import statements"
    - "Lines 3-7: box-sizing reset (DUPLICATE ‚Üí remove)"
    - "Lines 9-29: clearfix patterns (DUPLICATE ‚Üí remove)"
    - "Lines 31-40: sr-only utility (DUPLICATE ‚Üí remove)"
    - "Lines 41-100: FL-Builder grid (DUPLICATE ‚Üí remove)"
    - "Lines 101-200: Margin/display utilities (DUPLICATE ‚Üí remove)"
    - "Lines 201-500: Component overrides (EVALUATE)"
    - "Lines 501+: .fl-node-* selectors (PRESERVE)"

  after_consolidation_structure:
    - "Lines 1-2: @import statements (kept)"
    - "Lines 3-100: Component overrides (page-specific only)"
    - "Lines 101+: .fl-node-* selectors (all preserved)"

  size_reduction: "~300 lines removed, ~200 lines remaining"

blocklist_final_handling:
  404_css:
    action: "Process ONLY AFTER 404-critical.html created and tested"
    validation: "Navigate to /404.html, verify base-foundation.css loads"

  3114_layout_css:
    action: "Process ONLY AFTER blog-critical.html created and tested"
    validation: "Navigate to /blog/, verify base-foundation.css loads"

memory_storage:
  - "hugo/css/layer-5/consolidation-results/[page-id]/20251014"
  - "Document per page: Duplicates removed, .fl-node-* preserved, screenshot validation"

expected_impact_per_page:
  duplicates_removed: "~5KB per page (foundation + grid + utilities)"
  total_across_20_pages: "~100KB total reduction"
  visual_risk: "HIGH - page-specific CSS directly affects appearance"
```

---

## üõ°Ô∏è MANDATORY VALIDATION PROTOCOL (ALL LAYERS)

### **Screenshot Guardian Protocol**
```yaml
screenshot_guardian_mandate:
  authority: "ABSOLUTE blocking authority over ALL commits"

  validation_steps:
    pre_change:
      - "Capture baseline screenshots for ALL affected pages"
      - "Store screenshots in visual-testing/screenshots/baseline/[timestamp]/"
      - "Document screenshot metadata (page, viewport, timestamp)"

    post_change:
      - "Capture new screenshots after CSS changes"
      - "Store screenshots in visual-testing/screenshots/post-change/[timestamp]/"
      - "Run: assert_stable_screenshot with tolerance: 0.0 for refactoring"

    comparison:
      - "Calculate pixel-by-pixel differences"
      - "Generate visual diff report"
      - "Provide exact percentage difference per page"

    blocking_conditions:
      - "ANY difference > 0% during refactoring ‚Üí BLOCK commit"
      - "Footer layout changes ‚Üí IMMEDIATE BLOCK"
      - "Text content changes ‚Üí IMMEDIATE BLOCK"
      - "Missing elements ‚Üí IMMEDIATE BLOCK"
      - "Styling regressions ‚Üí IMMEDIATE BLOCK"

  approval_evidence_required:
    - "Screenshot comparison images provided ‚úì"
    - "Exact pixel differences reported per page ‚úì"
    - "ALL detected visual changes listed ‚úì"
    - "Zero visual changes verified before approving commit ‚úì"
```

### **Four-Eyes Approval Protocol**
```yaml
four_eyes_validation:
  step_1_coder:
    - "Coder implements CSS consolidation"
    - "Coder runs self-review of changes"
    - "Coder captures screenshots and performs self-comparison"
    - "Coder runs: bin/rake test:critical"

  step_2_reviewer:
    - "Reviewer validates CSS pattern preservation"
    - "Reviewer checks for removed page-specific CSS (.fl-node-*)"
    - "Reviewer verifies infrastructure loads (base-foundation.css, fl-builder-grid.css)"
    - "Reviewer validates screenshot comparison methodology"

  step_3_screenshot_guardian:
    - "Screenshot Guardian performs independent visual validation"
    - "Screenshot Guardian runs: assert_stable_screenshot with tolerance: 0.0"
    - "Screenshot Guardian provides detailed diff report"
    - "Screenshot Guardian verifies ZERO visual changes"
    - "‚ö†Ô∏è BLOCKING: Screenshot Guardian has ABSOLUTE blocking authority"

  step_4_tester:
    - "Tester runs: bin/rake test:critical"
    - "Tester validates ALL tests pass"
    - "Tester verifies test baselines unchanged"
    - "Tester confirms behavioral integrity"

  final_approval:
    requirements:
      - "Coder approval: CSS consolidation implemented ‚úì"
      - "Reviewer approval: Pattern compliance validated ‚úì"
      - "Screenshot Guardian approval: Zero visual changes validated ‚úì"
      - "Tester approval: Tests pass and baselines preserved ‚úì"

    blocking_rule: "ALL four approvals REQUIRED. ANY agent BLOCKS ‚Üí STOP, investigate, fix, re-validate"
```

---

## üìä PROGRESS TRACKING

### **Weekly Checkpoints**
```yaml
week_1_completion:
  - "‚úì Layer 0 audit complete"
  - "‚úì Layer 1 base-foundation.css created"
  - "‚úì 404-critical.html and blog-critical.html infrastructure created"
  - "‚úì Foundation duplicates removed from numbered layouts"

week_2_completion:
  - "‚úì Layer 2 utility consolidation complete"
  - "‚úì Layer 4 FL-Builder grid consolidation complete"
  - "‚úì Screenshot validations pass with tolerance: 0.0"

week_3_completion:
  - "‚úì Layer 3 component consolidation complete"
  - "‚úì Component API documented"

week_4_6_completion:
  - "‚úì Layer 5 page-specific consolidation complete"
  - "‚úì ALL 50+ page files processed"
  - "‚úì Blocklist files (404.css, 3114-layout.css) processed"
  - "‚úì Final validation: 0% visual regression across ALL pages"
```

---

**Guide Prepared By**: Architecture Expert (Tactical Execution Planning)
**Coordination**: Memory namespace: `hugo/css/tactical-execution/20251014`
**Reference**: top-down-consolidation-strategy.md (Strategic overview)
