# CSS Loading Priority Map
**Phase 1 Analysis - Critical Path CSS vs Regular CSS Loading Sequence**
**Generated**: 2025-10-12
**Analysts**: Loading-Priority-Mapper + Critical-Path-Expert pair
**Purpose**: Map CSS loading architecture to maintain performance optimization during consolidation

---

## Executive Summary

**Critical Path CSS**: 16,151 lines across 17 files (loads FIRST, inlined in `<head>`)
**Regular CSS**: 44,405 lines across 7 FL layout files (loads AFTER, external stylesheets)
**Loading Strategy**: Two-tier progressive enhancement - critical above-the-fold → full layout deferred
**Consolidation Impact**: MUST maintain loading priority order during foundation extraction

---

## Loading Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│ 1. CRITICAL PATH CSS (Inlined in <head> via <style> tags)  │
│    Priority: FIRST (above-the-fold rendering)               │
│    Method: Hugo resources.Get + PostCSS + fingerprint       │
│    Total: 16,151 lines                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. REGULAR CSS (External <link> stylesheets)                │
│    Priority: AFTER (below-the-fold, progressive)            │
│    Method: Hugo resources.Get + PostCSS + fingerprint       │
│    Total: 44,405 lines (fl-*-layout.css files)             │
└─────────────────────────────────────────────────────────────┘
```

---

## Critical Path CSS Files (Priority Tier 1)

### Base Critical CSS (Universal - ALL Pages)

**File**: `themes/beaver/assets/css/critical/base.css` (14 lines, orchestrator)
**Loading**: Via `themes/beaver/layouts/partials/header/critical/base-critical.html`
**Method**: Inline `<style>{{ $criticalCSS.Content | safeCSS }}</style>`

**Imports Structure**:
```css
/* base.css orchestrates critical foundations */
@import "critical/fl-layout-grid.css";        /* 549 lines - FL-Builder grid */
@import "critical/fl-common-modules.css";     /* 865 lines - FL-Builder modules */
@import "critical/fl-shape-dividers.css";     /* 48 lines - Shape divider layers */
@import "critical/base-reset.css";            /* 8 lines - CSS reset */
```

**Total Base Critical**: 1,484 lines

---

### Page-Specific Critical CSS (Per-Page Above-the-Fold)

| Page Template | Critical CSS File | Lines | HTML Partial |
|---------------|------------------|-------|--------------|
| Homepage | homepage-critical.css | 2,265 | header/critical/homepage.html |
| About Us | about-us-critical.css | 1,891 | header/critical/about-us.html |
| Careers | careers-critical.css | 1,815 | header/critical/careers.html |
| Clients | clients-critical.css | 358 | header/critical/clients.html |
| Services | services-critical.css | 634 | header/critical/services.html |
| Use Cases | use-cases-critical.css | 278 | header/critical/use-cases.html |
| Free Consultation | free-consultation-critical.css | 1,013 | header/critical/free-consultation.html |
| Privacy Policy | privacy-policy-critical.css | 464 | header/critical/privacy-policy.html |

**Total Page-Specific Critical**: 8,718 lines

---

### Single Post Critical CSS (Dynamic Content Templates)

| Template Type | Critical CSS File | Lines | Usage |
|---------------|------------------|-------|-------|
| Single Career Post | single-careers.css | 2,300 | Individual career post pages |
| Single Client Case Study | single-clients.css | 1,833 | Individual client pages |
| Single Use Case | single-use-cases.css | 1,815 | Individual use case pages |
| Single Service | single-services.css | 1 | Individual service pages |

**Total Single Post Critical**: 5,949 lines

---

### Critical Path CSS Summary

| Category | Files | Lines | Load Priority |
|----------|-------|-------|---------------|
| Base Critical (Universal) | 5 | 1,484 | FIRST (all pages) |
| Page-Specific Critical | 8 | 8,718 | FIRST (per page type) |
| Single Post Critical | 4 | 5,949 | FIRST (dynamic content) |
| **TOTAL CRITICAL PATH** | **17** | **16,151** | **Tier 1: Inlined** |

---

## Regular CSS Files (Priority Tier 2)

### FL Layout Files (Page-Specific Full Styles)

| Layout File | Lines | Purpose | Load Priority |
|-------------|-------|---------|---------------|
| fl-homepage-layout.css | 12,324 | Homepage full layout | AFTER critical |
| fl-services-layout.css | 6,484 | Services page layout | AFTER critical |
| fl-use-cases-layout.css | 6,472 | Use cases page layout | AFTER critical |
| fl-service-detail-layout.css | 5,470 | Service detail page layout | AFTER critical |
| fl-clients-layout.css | 5,465 | Clients page layout | AFTER critical |
| fl-about-layout.css | 4,463 | About page layout | AFTER critical |
| fl-careers-layout.css | 3,727 | Careers page layout | AFTER critical |
| **TOTAL REGULAR CSS** | **44,405** | **Below-fold styles** | **Tier 2: External** |

---

## Loading Sequence by Page Type

### Example: Homepage Loading Order

```html
<!-- themes/beaver/layouts/index.html (homepage template) -->

<!-- TIER 1: CRITICAL PATH CSS (Inlined in <head>) -->
<head>
  <!-- Step 1: Base Critical CSS (universal foundations) -->
  {{ partial "header/critical/base-critical.html" . }}
  <!-- Loads: fl-layout-grid.css, fl-common-modules.css, fl-shape-dividers.css, base-reset.css -->

  <!-- Step 2: Homepage-Specific Critical CSS (above-the-fold) -->
  {{ partial "header/critical/homepage.html" . }}
  <!-- Loads: homepage-critical.css (2,265 lines) -->
</head>

<!-- TIER 2: REGULAR CSS (External <link> in <head> or deferred) -->
<head>
  {{- $css := resources.Get "css/fl-homepage-layout.css" | postCSS | fingerprint "md5" -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" media="print" onload="this.media='all'">
  <!-- Loads: fl-homepage-layout.css (12,324 lines) after critical rendering -->
</head>
```

**Total Homepage CSS**: 1,484 (base) + 2,265 (homepage critical) + 12,324 (full layout) = **16,073 lines**

---

### Example: Careers Page Loading Order

```html
<!-- themes/beaver/layouts/careers.html (careers template) -->

<!-- TIER 1: CRITICAL PATH CSS -->
<head>
  <!-- Step 1: Base Critical CSS -->
  {{ partial "header/critical/base-critical.html" . }}
  <!-- Loads: 1,484 lines (base critical) -->

  <!-- Step 2: Careers-Specific Critical CSS -->
  {{ partial "header/critical/careers.html" . }}
  <!-- Loads: careers-critical.css (1,815 lines) -->
</head>

<!-- TIER 2: REGULAR CSS -->
<head>
  {{- $css := resources.Get "css/fl-careers-layout.css" | postCSS | fingerprint "md5" -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" media="print" onload="this.media='all'">
  <!-- Loads: fl-careers-layout.css (3,727 lines) after critical rendering -->
</head>
```

**Total Careers CSS**: 1,484 (base) + 1,815 (careers critical) + 3,727 (full layout) = **7,026 lines**

---

## Critical Path CSS Component Analysis

### FL-Layout-Grid.css (549 lines - Core Critical Grid)

**Purpose**: FL-Builder grid system foundations
**Loading**: Universal (all pages via base.css)
**Priority**: HIGHEST (layout framework dependency)

**Key Components**:
```css
/* Clearfix system for FL-Builder elements */
.fl-row:before, .fl-row:after, .fl-row-content:before, .fl-row-content:after,
.fl-col-group:before, .fl-col-group:after, .fl-col:before, .fl-col:after

/* FL-Builder basic grid layout */
.fl-row, .fl-row-content { margin-left: auto; margin-right: auto; min-width: 0; }

/* FL-Col-Group equal height flexbox */
.fl-col-group-equal-height { display: flex; flex-wrap: wrap; width: 100%; }

/* Responsive visibility utilities */
.fl-visible-large, .fl-visible-medium, .fl-visible-mobile, .fl-visible-desktop
```

**Consolidation Impact**:
- ⚠️ **CRITICAL**: This file MUST remain in critical path
- ✅ **Safe to extract**: Common .fl-row/.fl-col patterns can reference this
- ❌ **Do NOT move**: Cannot defer to regular CSS without breaking above-the-fold rendering

---

### FL-Common-Modules.css (865 lines - FL-Builder Module Styles)

**Purpose**: FL-Builder module components (buttons, photos, headings, PowerPack)
**Loading**: Universal (all pages via base.css)
**Priority**: HIGH (interactive elements)

**Key Components**:
```css
/* FL-Builder button modules */
.fl-button, .fl-button-wrap, .fl-button-icon

/* FL-Builder photo modules */
.fl-photo, .fl-photo-content, .fl-photo-img-jpg

/* FL-Builder heading modules */
.fl-heading, .fl-heading-text

/* PowerPack modules */
.pp-infobox, .pp-advanced-menu, .pp-content-tile
```

**Consolidation Impact**:
- ⚠️ **CRITICAL**: Interactive elements need immediate styling
- ✅ **Safe to consolidate**: Module variants can extend from this foundation
- ❌ **Do NOT duplicate**: Regular CSS should NOT redefine these modules

---

### FL-Shape-Dividers.css (48 lines - Shape Divider Layers)

**Purpose**: FL-Builder shape divider layer system
**Loading**: Universal (all pages via base.css)
**Priority**: MEDIUM (visual enhancement, not blocking)

**Key Components**:
```css
/* Shape divider layering system */
.fl-builder-shape-layer, .fl-builder-shape-mask
```

**Consolidation Impact**:
- ✅ **Can optimize**: May be candidate for deferred loading (not critical rendering)
- ✅ **Safe to consolidate**: Single source of truth
- ⚠️ **Evaluate**: Test if shape dividers are truly above-the-fold

---

### Page-Specific Critical CSS (8,718 lines total)

**Purpose**: Above-the-fold styles for each page type
**Loading**: Per-page (only loads for specific page template)
**Priority**: HIGH (first paint optimization)

**Example: homepage-critical.css (2,265 lines)**
```css
/* Above-the-fold hero section */
.fl-node-{homepage_hero_id} { ... }

/* Above-the-fold CTA section */
.fl-node-{homepage_cta_id} { ... }

/* Above-the-fold testimonial section */
.fl-node-{homepage_testimonial_id} { ... }
```

**Consolidation Impact**:
- ⚠️ **DELICATE**: Must preserve page-specific critical rendering
- ✅ **Can consolidate**: Common .fl-node- patterns across critical files
- ❌ **Do NOT mix**: Critical CSS must stay separate from regular CSS
- ✅ **Safe to optimize**: Remove below-the-fold styles from critical CSS

---

## Consolidation Strategy for Loading Priority

### Rule 1: Preserve Critical Path Integrity

**MANDATORY**:
- Critical CSS files MUST remain inlined in `<head>` via `<style>` tags
- Critical CSS loading order MUST remain: base.css → page-specific critical
- Critical CSS MUST NOT reference regular CSS files (circular dependency)

**Safe Consolidation**:
```css
/* CORRECT: Critical CSS imports critical foundations */
/* themes/beaver/assets/css/critical/homepage-critical.css */
@import "critical/fl-layout-grid.css";  /* ✅ SAFE - critical imports critical */
@import "utilities/fl-builder-grid.css"; /* ❌ UNSAFE - critical imports regular utility */
```

---

### Rule 2: Regular CSS Can Reference Critical Foundations

**ALLOWED**:
- Regular CSS (fl-*-layout.css) CAN use @import for critical foundations
- Regular CSS loads AFTER critical, so no circular dependencies

**Safe Consolidation**:
```css
/* CORRECT: Regular CSS extends critical foundations */
/* themes/beaver/assets/css/fl-homepage-layout.css */
@import "critical/fl-layout-grid.css";  /* ✅ SAFE - extends critical grid */
@import "utilities/fl-builder-grid.css"; /* ✅ SAFE - imports utility foundation */
```

---

### Rule 3: Foundation Extraction Priority

**Priority 1: Extract to Regular CSS Utilities** (Default Strategy)
```
foundations/_fl-row-foundation.scss
foundations/_fl-col-foundation.scss
foundations/_fl-responsive-display.scss
```
- Used by regular CSS files (fl-*-layout.css)
- Does NOT affect critical path loading
- Safe for aggressive consolidation

**Priority 2: Extract to Critical CSS Foundations** (Use Sparingly)
```
critical/fl-layout-grid.css (ALREADY exists - 549 lines)
critical/fl-common-modules.css (ALREADY exists - 865 lines)
```
- Only for truly above-the-fold universal components
- Must remain small (<1,000 lines per file)
- Affects ALL page loads (base-critical.html)

---

### Rule 4: Page-Specific Critical CSS Consolidation

**Strategy**: Consolidate WITHIN critical tier, not ACROSS tiers

**CORRECT Consolidation**:
```css
/* Extract common .fl-node- patterns WITHIN critical CSS */
/* critical/_fl-node-hero-patterns.scss */
.fl-node-hero-base { ... }

/* homepage-critical.css imports hero patterns */
@import "critical/_fl-node-hero-patterns.scss";
```

**INCORRECT Consolidation**:
```css
/* ❌ FORBIDDEN: Moving critical styles to regular CSS */
/* fl-homepage-layout.css */
@import "critical/homepage-critical.css"; /* BREAKS loading priority */
```

---

## Loading Priority Constraints for Phase 2

### WP2.1: FL-Row Foundation Extraction

**Target**: Extract FL-row patterns from regular CSS (fl-*-layout.css)
**Constraint**: Do NOT extract from critical CSS (fl-layout-grid.css)
**Safe Approach**:
```
foundations/_fl-row-foundation.scss (NEW - for regular CSS)
critical/fl-layout-grid.css (EXISTING - for critical CSS, do NOT modify)
```

---

### WP2.2: FL-Col Grid Foundation Extraction

**Target**: Extract FL-col patterns from regular CSS
**Constraint**: Do NOT extract from critical CSS
**Safe Approach**:
```
foundations/_fl-col-foundation.scss (NEW - for regular CSS)
critical/fl-layout-grid.css (EXISTING - contains .fl-col critical base, preserve)
```

---

### WP2.3: FL-Responsive Display Foundation Extraction

**Target**: Extract FL-visible patterns from regular CSS
**Constraint**: Critical CSS already has .fl-visible in fl-layout-grid.css (549 lines)
**Safe Approach**:
```
foundations/_fl-responsive-display.scss (NEW - for regular CSS extended utilities)
critical/fl-layout-grid.css (EXISTING - contains .fl-visible critical base, preserve)
```

**Strategy**:
- Critical CSS: .fl-visible-{desktop|large|medium|mobile} base definitions
- Regular CSS foundation: .fl-visible extended utilities, custom breakpoints

---

### WP2.4: PP-Tabs Component Consolidation

**Target**: Extract PP-tabs from regular CSS (fl-homepage/services/use-cases-layout.css)
**Constraint**: PP-tabs are NOT in critical CSS (below-the-fold component)
**Safe Approach**:
```
components/_pp-tabs-foundation.scss (NEW - safe for regular CSS)
```

**No Critical Path Impact**: ✅ SAFE for aggressive consolidation

---

### WP2.5: FL-Node Page-Specific Consolidation

**Target**: Extract common .fl-node- patterns
**Constraint**: BOTH critical AND regular CSS contain .fl-node- selectors
**Critical Approach**:

**CRITICAL CSS .fl-node- rules** (must preserve):
- homepage-critical.css: Above-the-fold hero/CTA nodes
- careers-critical.css: Above-the-fold career listing nodes
- etc.

**REGULAR CSS .fl-node- rules** (safe to consolidate):
- fl-homepage-layout.css: Below-the-fold nodes
- fl-careers-layout.css: Below-the-fold nodes
- etc.

**Safe Strategy**:
```
/* Critical tier - preserve as-is */
critical/homepage-critical.css (contains above-the-fold .fl-node- rules)

/* Regular tier - consolidate common patterns */
foundations/_fl-node-common-patterns.scss (extracts below-the-fold patterns)
page-overrides/homepage-nodes.scss (page-specific overrides)
```

---

## Performance Impact Analysis

### Current Performance Characteristics

**First Paint**: Critical CSS (1,484 base + ~2,000 page-specific = ~3,500 lines inlined)
**Full Render**: Critical CSS + Regular CSS (~3,500 + ~6,000 avg per page = ~9,500 lines total)

**Loading Strategy**:
```html
<!-- Critical CSS: Inlined, blocks initial render (necessary) -->
<style>{{ $criticalCSS.Content | safeCSS }}</style>

<!-- Regular CSS: Deferred via media="print" onload trick -->
<link rel="stylesheet" href="fl-homepage-layout.css" media="print" onload="this.media='all'">
```

---

### Post-Consolidation Performance Targets

**First Paint**: Critical CSS UNCHANGED (~3,500 lines inlined)
**Full Render**: Regular CSS REDUCED (~9,500 → ~5,500 lines via foundation consolidation)

**Benefits**:
- ✅ Critical path rendering UNCHANGED (no performance regression)
- ✅ Regular CSS load time IMPROVED (~42% reduction)
- ✅ Cache efficiency IMPROVED (shared foundation files)
- ✅ Maintenance IMPROVED (single source of truth)

---

## Consolidation Safety Checklist

**Before extracting ANY component to foundation**:

- [ ] **Check Critical Path**: Is component in critical/*.css files?
  - ✅ YES → Extract to critical foundation OR preserve as-is
  - ✅ NO → Safe to extract to regular CSS foundation

- [ ] **Check Loading Order**: Does extraction change critical → regular order?
  - ✅ NO change → SAFE
  - ❌ Changes order → UNSAFE, revise approach

- [ ] **Check Import Direction**: Does critical CSS import regular CSS?
  - ✅ NO → SAFE
  - ❌ YES → FORBIDDEN, breaks loading priority

- [ ] **Check File Size**: Does critical CSS foundation exceed 1,000 lines?
  - ✅ NO → SAFE
  - ❌ YES → Consider splitting or deferring

- [ ] **Test Performance**: Does change affect First Contentful Paint (FCP)?
  - ✅ FCP unchanged or improved → SAFE
  - ❌ FCP degraded → ROLLBACK

---

## Recommendations

1. **Preserve Critical Path**: Do NOT modify critical/*.css files during Phase 2 foundation extraction
2. **Regular CSS Focus**: Extract foundations from fl-*-layout.css files ONLY
3. **Critical CSS Audit**: Phase 3 can optimize critical CSS AFTER regular CSS consolidation
4. **Loading Priority Testing**: Validate critical → regular order after each extraction
5. **Performance Monitoring**: Run bin/rake test:critical + Lighthouse after consolidation

---

## Hugo Template Loading Sequence

**Base Template** (`themes/beaver/layouts/_default/baseof.html`):
```html
<head>
  <!-- CRITICAL CSS: Universal base -->
  {{ partial "header/critical/base-critical.html" . }}

  <!-- CRITICAL CSS: Page-specific (injected by child templates) -->
  {{ block "critical-css" . }}{{ end }}

  <!-- REGULAR CSS: Page-specific (injected by child templates) -->
  {{ block "page-css" . }}{{ end }}
</head>
```

**Child Template** (`themes/beaver/layouts/index.html`):
```html
{{ define "critical-css" }}
  {{ partial "header/critical/homepage.html" . }}
{{ end }}

{{ define "page-css" }}
  {{- $css := resources.Get "css/fl-homepage-layout.css" | postCSS | fingerprint "md5" -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" media="print" onload="this.media='all'">
{{ end }}
```

**Loading Sequence**:
1. Base critical CSS (base-critical.html) → 1,484 lines inlined
2. Page critical CSS (homepage.html) → 2,265 lines inlined
3. Page regular CSS (fl-homepage-layout.css) → 12,324 lines external (deferred)

**Total Critical Rendering Path**: 3,749 lines (1,484 + 2,265)
**Total Regular CSS**: 12,324 lines (deferred, non-blocking)

---

**Next Phase**: Unused CSS Analysis (10.09-unused-css-report.md)
**Status**: Ready for hugo_stats.json cross-reference
**Critical Mandate**: Maintain loading priority during ALL consolidation work
