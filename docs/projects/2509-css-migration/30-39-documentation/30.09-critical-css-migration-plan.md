# Critical CSS Migration Plan: Partial ‚Üí Direct CSS Includes

## Executive Summary

**Current State**: Critical CSS is loaded via Hugo partials (`{{ partial "header/critical/..." }}`)
**Target State**: Direct CSS includes in layout files (following `home.html` pattern)
**Reason**: Eliminate Hugo partial overhead, improve build performance, simplify critical CSS management

---

## 1. Critical CSS Inventory

### 1.1 Critical CSS Partials (themes/beaver/layouts/partials/header/critical/)

| Partial File | Purpose | Inherits base-critical.html |
|--------------|---------|------------------------------|
| `base-critical.html` | Foundation styles for all pages | N/A (base file) |
| `homepage.html` | Homepage-specific critical CSS | ‚úÖ Yes (line 2) |
| `about-us.html` | About Us page critical CSS | ‚úÖ Yes (line 2) |
| `services.html` | Services listing page critical CSS | ‚úÖ Yes (line 3) |
| `clients.html` | Clients listing page critical CSS | ‚úÖ Yes (line 2) |
| `contact-us.html` | Contact Us page critical CSS | ‚úÖ Yes (line 2) |
| `free-consultation.html` | Free Consultation page critical CSS | ‚úÖ Yes (line 1) |
| `privacy-policy.html` | Privacy Policy page critical CSS | ‚úÖ Yes (line 1) |
| `careers.html` | Careers listing page critical CSS | Not checked yet |
| `single/careers.html` | Single career post critical CSS | Not checked yet |
| `single/clients.html` | Single client post critical CSS | Not checked yet |
| `single/services.html` | Single service post critical CSS | Not checked yet |
| `single/use-cases.html` | Single use case post critical CSS | Not checked yet |

### 1.2 Critical CSS Asset Files (themes/beaver/assets/css/critical/)

| CSS File | Corresponding Partial | Used By |
|----------|----------------------|---------|
| `base.css` | `base-critical.html` | All pages that load base-critical |
| `base-reset.css` | `base-critical.html` | Reset styles (part of base) |
| `fl-common-modules.css` | `base-critical.html` | FL-Builder common module styles |
| `fl-layout-grid.css` | `base-critical.html` | FL-Builder grid system |
| `fl-shape-dividers.css` | `base-critical.html` | FL-Builder shape divider styles |
| `homepage-critical.css` | `homepage.html` | Homepage only |
| `about-us-critical.css` | `about-us.html` | About Us page only |
| `services-critical.css` | `services.html` | Services listing page only |
| `clients-critical.css` | `clients.html` | Clients listing page only |
| `free-consultation-critical.css` | `free-consultation.html` | Free Consultation page only |
| `privacy-policy-critical.css` | `privacy-policy.html` | Privacy Policy page only |
| `careers-critical.css` | `careers.html` | Careers listing page only |
| `single-careers.css` | `single/careers.html` | Single career posts only |
| `single-clients.css` | `single/clients.html` | Single client posts only |
| `single-services.css` | `single/services.html` | Single service posts only |
| `single-use-cases.css` | `single/use-cases.html` | Single use case posts only |
| `use-cases-critical.css` | Not found in partials | Use Cases listing page |

---

## 2. Page Template ‚Üí Critical CSS Mapping

### 2.1 ‚úÖ MIGRATED (Direct CSS Includes - Following home.html Pattern)

| Layout File | CSS Loading Method | Critical CSS Files |
|-------------|-------------------|-------------------|
| `themes/beaver/layouts/home.html` | ‚úÖ Direct CSS in footer block | `base-critical.html`, `homepage-critical.css` |
| `themes/beaver/layouts/page/about.html` | ‚úÖ Direct CSS in header block | `base.css`, `701-layout.css` |
| `themes/beaver/layouts/page/services.html` | ‚úÖ Direct CSS in header block | `base.css`, `services-critical.css` |
| `themes/beaver/layouts/404.html` | ‚úÖ Direct CSS in header block | `404.css` (NO base-critical!) |
| `themes/beaver/layouts/single.html` (Blog) | ‚úÖ Direct CSS in header block | `3114-layout.css` (NO base-critical!) |

**Note**: 404.html and single.html (blog) do NOT load base-critical.html infrastructure, which is why CSS consolidation is BLOCKED for these pages (learned from CSS consolidation incident).

### 2.2 ‚ùå NEEDS MIGRATION (Still Using Partials)

| Layout File | Current Method | Target Migration |
|-------------|---------------|------------------|
| `themes/beaver/layouts/_test/single.html` | Partial: `base-critical.html` | Convert to direct CSS include |
| `themes/beaver/layouts/page/service-template.html` | Partial: `single/services.html` | Convert to direct CSS include |

### 2.3 üîç UNKNOWN (Need Investigation)

| Layout File | Investigation Needed |
|-------------|---------------------|
| `themes/beaver/layouts/blog/list.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/list.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/careers.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/clients.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/contact-us.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/free-consultation.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/use-cases.html` | Check if uses critical CSS partials |
| `themes/beaver/layouts/page/single.html` | Check if uses critical CSS partials |

---

## 3. Migration Strategy (home.html Pattern)

### 3.1 Home.html Pattern Analysis

**Current home.html approach** (lines 5-21):
```go
{{ define "footer" }}
  {{- $nonCriticalResources := slice
    (resources.Get "header/critical/base-critical.html")
    (resources.Get "css/critical/homepage-critical.css")
    (resources.Get "css/companies.css")
    (resources.Get "css/footer.css")
    (resources.Get "css/homepage.css")
    (resources.Get "css/dynamic-404-590.css" | resources.ExecuteAsTemplate "css/dynamic.css" .)
    (resources.Get "css/590-layout.css")
    (resources.Get "css/skin-65eda28877e04.css")
    (resources.Get "css/style.css")
    (resources.Get "css/dynamic-icons.css" | resources.ExecuteAsTemplate "css/dynamic586.css" .)
    (resources.Get "css/586.css")
    (resources.Get "css/technologies.css")
    (resources.Get "css/use-cases-dynamic.css" | resources.ExecuteAsTemplate "css/use-cases-dynamic.css" .)
  }}

  {{ partialCached "assets/css-processor.html" (dict "resources" $nonCriticalResources "bundleName" "homepage") "homepage" }}
{{ end }}
```

**Key Observation**: home.html loads `header/critical/base-critical.html` as a **resource** (line 6), not as a **partial**. This is the target pattern!

### 3.2 Migration Pattern (Step-by-Step)

For each page layout that currently uses `{{ partial "header/critical/..." }}`:

#### **Step 1**: Identify current partial usage
```bash
# Example: Find partial usage in layout
grep 'partial "header/critical/' themes/beaver/layouts/page/service-template.html
# Output: {{ partial "header/critical/single/services.html" . }}
```

#### **Step 2**: Map partial ‚Üí CSS assets
```yaml
# Example for service-template.html
Partial: single/services.html
Maps to CSS: css/critical/base.css + css/critical/single-services.css
```

#### **Step 3**: Replace partial with direct CSS include
```go
# BEFORE (using partial)
{{ define "header" }}
  {{ partial "header/critical/single/services.html" . }}
{{ end }}

# AFTER (direct CSS include - home.html pattern)
{{ define "header" }}
  {{- $cssResources := slice
    (resources.Get "css/critical/base.css")
    (resources.Get "css/critical/single-services.css")
    (resources.Get "css/[other-page-specific].css")
    (resources.Get "css/footer.css")
  }}
  {{ partialCached "assets/css-processor.html" (dict "resources" $cssResources "bundleName" "service-single") "service-single" }}
{{ end }}
```

#### **Step 4**: Visual regression testing
```bash
# Capture baseline screenshots BEFORE migration
bin/rake test:critical

# After migration, compare screenshots
bin/rake test:critical

# MUST show 0% visual difference (tolerance: 0.0 for refactoring)
```

---

## 4. Migration Checklist (Per Page Template)

### Template: `themes/beaver/layouts/page/service-template.html`

- [ ] **Step 1**: Capture baseline screenshots (all service pages)
- [ ] **Step 2**: Identify current partial: `single/services.html`
- [ ] **Step 3**: Map to CSS assets:
  - `css/critical/base.css`
  - `css/critical/single-services.css`
  - Other page-specific CSS files
- [ ] **Step 4**: Replace partial with direct CSS slice in `{{ define "header" }}`
- [ ] **Step 5**: Test build: `bin/hugo-build`
- [ ] **Step 6**: Run visual regression tests: `bin/rake test:critical`
- [ ] **Step 7**: Validate 0% visual difference (tolerance: 0.0)
- [ ] **Step 8**: Commit on green tests
- [ ] **Step 9**: Document migration in this file

### Template: `themes/beaver/layouts/_test/single.html`

- [ ] **Step 1**: Capture baseline screenshots
- [ ] **Step 2**: Identify current partial: `base-critical.html`
- [ ] **Step 3**: Map to CSS assets:
  - `css/critical/base.css`
  - `css/critical/base-reset.css`
  - `css/critical/fl-common-modules.css`
  - `css/critical/fl-layout-grid.css`
  - `css/critical/fl-shape-dividers.css`
- [ ] **Step 4**: Replace partial with direct CSS slice
- [ ] **Step 5**: Test build
- [ ] **Step 6**: Run visual regression tests
- [ ] **Step 7**: Validate 0% visual difference
- [ ] **Step 8**: Commit on green tests
- [ ] **Step 9**: Document migration

### Template: `themes/beaver/layouts/blog/list.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: If YES ‚Üí follow migration steps above
- [ ] **Step 3**: If NO ‚Üí mark as ‚úÖ Already migrated or N/A

### Template: `themes/beaver/layouts/list.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/careers.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/clients.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/contact-us.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/free-consultation.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/use-cases.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

### Template: `themes/beaver/layouts/page/single.html`

- [ ] **Step 1**: Check if uses critical CSS partials
- [ ] **Step 2**: Follow migration steps if needed

---

## 5. Partial Cleanup (After All Migrations Complete)

Once ALL page templates are migrated to direct CSS includes:

### 5.1 Mark Partials as Deprecated

- [ ] Add deprecation notice to each `themes/beaver/layouts/partials/header/critical/*.html` file
- [ ] Document migration completion date

### 5.2 Delete Partials (After 1 Sprint Buffer)

- [ ] **Wait 1 sprint** to ensure no regressions
- [ ] Delete all files in `themes/beaver/layouts/partials/header/critical/`
- [ ] Remove directory: `themes/beaver/layouts/partials/header/critical/`

### 5.3 Update Documentation

- [ ] Update project documentation to reflect new pattern
- [ ] Add migration guide for future critical CSS additions
- [ ] Document `home.html` as canonical pattern for critical CSS loading

---

## 6. Benefits of Migration

### 6.1 Performance Improvements

- **Eliminate Hugo partial overhead**: Direct resource loading is faster than partial rendering
- **Better build caching**: Hugo can cache direct resource references more effectively
- **Reduced template complexity**: Fewer partial lookups during build

### 6.2 Maintainability Improvements

- **Single source of truth**: CSS files live only in `assets/css/critical/`
- **Clearer dependency tracking**: Page layouts explicitly declare CSS dependencies
- **Easier debugging**: No indirection through partials
- **Simpler critical CSS management**: Add new critical CSS by adding to slice, not creating partial

### 6.3 Developer Experience Improvements

- **Follows Hugo best practices**: Direct resource references are recommended approach
- **Consistent pattern**: All pages use same CSS loading mechanism (home.html pattern)
- **Easier code review**: CSS dependencies visible in layout file

---

## 7. Risk Mitigation

### 7.1 Visual Regression Protection

**MANDATORY**: Use Screenshot Guardian with **tolerance: 0.0** for ALL migrations
- Capture baseline BEFORE any changes
- Compare screenshots AFTER migration
- **BLOCK** any commits with visual changes >0%

### 7.2 Incremental Migration

- Migrate ONE page template at a time
- Test and commit after each migration
- Rollback immediately if visual regressions detected

### 7.3 Critical Path Awareness

**BLOCK LIST** (Cannot consolidate CSS until critical CSS infrastructure added):
- `404.html` - No base-critical.html loaded
- `blog/single.html` - No base-critical.html loaded

These pages require **separate migration strategy** or acceptance that CSS will remain duplicated.

---

## 8. Success Metrics

- [ ] **Build Time**: Measure Hugo build time before/after migration
- [ ] **CSS Bundle Size**: Track critical CSS bundle sizes (should remain unchanged)
- [ ] **Visual Regression**: 0 visual regressions (0% difference on all pages)
- [ ] **Code Reduction**: Track lines of code removed (partial files deleted)
- [ ] **Maintainability**: Fewer files to maintain, clearer dependencies

---

## 9. Migration Timeline

### Phase 1: Investigation & Planning (Week 1)
- [ ] Complete investigation of all `üîç UNKNOWN` layouts
- [ ] Update this document with findings
- [ ] Create migration priority list

### Phase 2: High-Value Migrations (Week 2-3)
- [ ] Migrate most-used page templates first
- [ ] Focus on templates with highest CSS complexity

### Phase 3: Remaining Migrations (Week 4-5)
- [ ] Migrate remaining templates
- [ ] Clean up deprecated partials

### Phase 4: Validation & Cleanup (Week 6)
- [ ] Final visual regression validation
- [ ] Delete deprecated partial directory
- [ ] Update documentation

---

## 10. References

- **Home.html Pattern**: `/Users/pftg/dev/jetthoughts.github.io/themes/beaver/layouts/home.html` (lines 5-21)
- **CSS Consolidation Learnings**: `CLAUDE.md` ‚Üí CRITICAL CSS CONSOLIDATION LEARNINGS
- **Visual Testing Protocol**: `docs/visual_testing_delegation_workflows.md`
- **Test Format Requirements**: `docs/60.06-test-format-requirements-reference.md`

---

## Appendix A: Quick Reference Commands

```bash
# Find all layouts using critical CSS partials
grep -r 'partial "header/critical/' themes/beaver/layouts/

# List all critical CSS asset files
find themes/beaver/assets/css/critical -type f -name "*.css" | sort

# Capture baseline screenshots (BEFORE migration)
bin/rake test:critical

# Run Hugo build (test compilation)
bin/hugo-build

# Compare screenshots (AFTER migration)
bin/rake test:critical

# Validate zero visual changes
# Expected: 0% difference on all pages (tolerance: 0.0 for refactoring)
```

---

## Appendix B: Example Migration (Complete)

### Before: Using Partial
```go
{{ define "header" }}
  {{ partial "header/critical/single/services.html" . }}
{{ end }}
```

### After: Direct CSS Include (home.html pattern)
```go
{{ define "header" }}
  {{- $cssResources := slice
    (resources.Get "css/critical/base.css")
    (resources.Get "css/critical/fl-common-modules.css")
    (resources.Get "css/critical/fl-layout-grid.css")
    (resources.Get "css/critical/fl-shape-dividers.css")
    (resources.Get "css/critical/single-services.css")
    (resources.Get "css/737-layout.css")
    (resources.Get "css/bf72bba397177a0376baed325bffdc75-layout-bundle.css")
    (resources.Get "css/dynamic-icons.css" | resources.ExecuteAsTemplate "css/dynamic586.css" .)
    (resources.Get "css/586.css")
    (resources.Get "css/footer.css")
  }}

  {{ partialCached "assets/css-processor.html" (dict "resources" $cssResources "bundleName" "service-single" "context" .) "service-single" }}
{{ end }}
```

### Validation Steps
1. ‚úÖ Baseline screenshots captured
2. ‚úÖ Migration applied
3. ‚úÖ Hugo build successful
4. ‚úÖ Visual regression tests pass (0% difference)
5. ‚úÖ Committed to version control

---

**Document Version**: 1.0
**Last Updated**: 2025-10-14
**Status**: Investigation Phase
**Next Action**: Complete investigation of `üîç UNKNOWN` layouts
