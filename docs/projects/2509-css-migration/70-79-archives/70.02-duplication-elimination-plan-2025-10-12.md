# CSS Duplication Elimination Execution Plan
**Date**: 2025-10-12
**Status**: Ready for Execution
**Target**: FL-row, FL-col, FL-visible component consolidation

---

## ✅ ALREADY EXTRACTED (Do NOT duplicate)

### Existing Utilities Inventory

**fl-builder-grid.css** (Comprehensive grid system):
- `.fl-row, .fl-row-content { margin-left: auto; margin-right: auto; min-width: 0; }`
- `.fl-row-content-wrap { position: relative; }`
- `.fl-col-group-equal-height { display: flex; flex-wrap: wrap; width: 100%; }`
- Clearfix patterns for .fl-row, .fl-col, .fl-module
- FL-row background media patterns (.fl-row-bg-video, .fl-row-bg-embed)
- **Lines**: ~200 lines of FL-row/FL-col patterns

**utilities/grid/fl-row.css**:
- `.fl-row, .fl-row-content { margin-left: auto; margin-right: auto; min-width: 0; }`
- `.fl-row-content-wrap { position: relative; }`
- `.fl-row-fixed-width { max-width: 1180px; min-width: 1px; }`
- **Lines**: ~20 lines (basic FL-row core)

**utilities/grid/fl-col.css**:
- `.fl-col { float: left; min-height: 1px; }`
- `.fl-col-content { margin: 0; padding: 0; }`
- **Lines**: ~14 lines (basic FL-col core)

**utilities/fl-builder-visibility.css**:
- `.fl-visible-{desktop|large|medium|mobile}` patterns
- Media query responsive visibility toggles
- Flexbox .fl-col-group-equal-height overrides
- **Lines**: ~63 lines (complete responsive visibility)

**foundations/_fl-responsive-display.scss**:
- Already exists (found in glob search)
- **Status**: Check if used or orphaned

---

## 🎯 DUPLICATION TARGETS (To eliminate from layout files)

### Layout Files Analysis

**7 Target Files**:
1. fl-homepage-layout.css (12,324 lines)
2. fl-services-layout.css (6,484 lines)
3. fl-use-cases-layout.css (6,472 lines)
4. fl-service-detail-layout.css (5,470 lines)
5. fl-clients-layout.css (5,465 lines)
6. fl-about-layout.css (4,462 lines)
7. fl-careers-layout.css (3,743 lines)

**Current @import Status**:
✅ ALL 7 files already import utilities/fl-builder-grid.css
✅ ALL 7 files already import utilities/fl-builder-visibility.css

**Problem**: Despite importing utilities, layout files STILL contain duplicated component definitions!

---

## 🔍 DUPLICATION PATTERNS TO ELIMINATE

### Pattern 1: FL-Row Fixed Width (EXACT DUPLICATE)
**Found in utilities/grid/fl-row.css**:
```css
.fl-row-fixed-width {
  max-width: 1180px;
  min-width: 1px;
}
```

**Duplicated in layout files**:
- fl-homepage-layout.css: `.fl-row-fixed-width { max-width: 1180px; }`
- fl-services-layout.css: `.fl-row-fixed-width { max-width: 1180px; }`
- (5 more files...)

**Action**: DELETE from all 7 layout files (already in utilities)

### Pattern 2: FL-Row Content Wrap Margins (EXACT DUPLICATE)
**Found in utilities**:
```css
.fl-row-content-wrap {
  margin-top: 0px;
  margin-right: 0px;
  margin-bottom: 0px;
  margin-left: 0px;
}
```

**Duplicated in layout files**: All 7 files
**Action**: DELETE from layout files (redundant with utility base)

### Pattern 3: FL-Row Background Overlay Z-Index
**Found in utilities/fl-builder-grid.css**: NO
**Found in layout files**: YES (all 7 files)

```css
.fl-row-bg-overlay .fl-builder-shape-layer { z-index: 1; }
.fl-row-bg-overlay .fl-builder-shape-layer.fl-builder-bottom-edge-layer { z-index: 2; }
.fl-row-has-layers .fl-row-content { z-index: 1; }
.fl-row-bg-overlay .fl-row-content { z-index: 2; }
```

**Action**: EXTRACT to utilities/fl-builder-grid.css (NEW pattern)

### Pattern 4: FL-Builder Layer System
**Found in layout files**: All 7 files duplicate this:
```css
.fl-builder-layer > * {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
}

.fl-builder-layer + .fl-row-content {
  position: relative;
}
```

**Action**: EXTRACT to utilities/fl-builder-grid.css (NEW pattern)

### Pattern 5: Page-Specific FL-Node Overrides
**Found in layout files**: Thousands of `.fl-node-{id}` rules
**Action**: KEEP in layout files (page-specific, NOT duplicates)

---

## 📋 EXECUTION STRATEGY

### Phase 1: Remove Exact Duplicates (SAFE)
**Target**: Patterns already in utilities that are redundantly redefined
**Risk**: LOW (utilities already loaded, just removing duplicates)
**Validation**: Tests should remain 100% green

**Steps**:
1. Remove `.fl-row-fixed-width` from layout files (already in utilities/grid/fl-row.css)
2. Remove redundant `.fl-row-content-wrap` margin declarations
3. Test after each file removal: `bin/rake test:critical`
4. Micro-commit on green

**Expected Savings**: ~100-200 lines across 7 files

### Phase 2: Extract New Common Patterns (MEDIUM RISK)
**Target**: Patterns duplicated across layout files but NOT yet in utilities
**Risk**: MEDIUM (need to ensure utilities load before layout files)
**Validation**: Visual regression + functional tests

**Steps**:
1. Extract FL-row background overlay z-index patterns to utilities/fl-builder-grid.css
2. Extract FL-builder-layer system to utilities/fl-builder-grid.css
3. Remove from layout files after utility extraction
4. Test after each extraction: `bin/rake test:critical`
5. Screenshot comparison: `bin/rake test:screenshots:compare`

**Expected Savings**: ~300-500 lines across 7 files

### Phase 3: Verify No New Duplications Created
**Target**: Ensure utilities themselves don't have internal duplications
**Risk**: LOW (verification only)

**Steps**:
1. Check utilities/fl-builder-grid.css for internal duplicates
2. Check utilities/grid/fl-row.css vs fl-builder-grid.css overlaps
3. Consolidate if overlaps found
4. Document final utility structure

---

## 🚨 CRITICAL CONSTRAINTS

### Loading Order (MUST PRESERVE)
1. **Critical CSS** (inlined in `<head>`) loads FIRST
2. **Utilities** (external CSS) load via @import in layout files
3. **Layout files** (page-specific CSS) load AFTER utilities

**Rule**: Layout files can safely delete patterns IF utilities already define them via @import

### What to KEEP in Layout Files
- ❌ **Do NOT remove**: Page-specific `.fl-node-{id}` rules
- ❌ **Do NOT remove**: Custom background colors/images per page
- ❌ **Do NOT remove**: One-off layout adjustments
- ✅ **CAN remove**: Exact duplicates of utility patterns

### What to EXTRACT to Utilities
- ✅ **Can extract**: Patterns duplicated across 3+ files
- ✅ **Can extract**: Common FL-row/FL-col/FL-visible patterns
- ❌ **Do NOT extract**: Page-specific overrides

---

## 📊 SUCCESS METRICS

### Quantitative Targets
- [ ] 400-700 lines eliminated from layout files
- [ ] 0 new duplications created in utilities
- [ ] 100% test pass rate maintained
- [ ] 0% visual regression (refactoring mode)

### Qualitative Checks
- [ ] Utilities load before layout files (via @import)
- [ ] No broken styles or layout shifts
- [ ] Critical CSS unmodified (maintains priority)
- [ ] Documentation updated

---

## 🛠️ EXECUTION COMMANDS

### Remove Exact Duplicates (Phase 1)
```bash
# Remove .fl-row-fixed-width from layout file (example)
sed -i '' '/^\.fl-row-fixed-width {$/,/^}$/d' themes/beaver/assets/css/fl-homepage-layout.css

# Test
bin/rake test:critical

# Commit on green
git add themes/beaver/assets/css/fl-homepage-layout.css
git commit -m "refactor(css): remove duplicate .fl-row-fixed-width from homepage-layout (WP2.1)"
```

### Extract New Patterns (Phase 2)
```bash
# Extract pattern to utility
cat >> themes/beaver/assets/css/utilities/fl-builder-grid.css <<'EOF'

/* FL-Row Background Overlay Z-Index */
.fl-row-bg-overlay .fl-builder-shape-layer { z-index: 1; }
.fl-row-bg-overlay .fl-builder-shape-layer.fl-builder-bottom-edge-layer { z-index: 2; }
.fl-row-has-layers .fl-row-content { z-index: 1; }
.fl-row-bg-overlay .fl-row-content { z-index: 2; }
EOF

# Remove from layout file
sed -i '' '/^\.fl-row-bg-overlay \.fl-builder-shape-layer {$/,/^}$/d' themes/beaver/assets/css/fl-homepage-layout.css

# Test
bin/rake test:critical
```

---

## 🎯 NEXT IMMEDIATE ACTION

Start with Phase 1, File 1: Remove `.fl-row-fixed-width` duplicate from fl-homepage-layout.css

**Command**:
```bash
# Verify pattern exists in layout file
grep -A 2 "^\.fl-row-fixed-width" themes/beaver/assets/css/fl-homepage-layout.css

# Verify pattern exists in utility
grep -A 2 "^\.fl-row-fixed-width" themes/beaver/assets/css/utilities/grid/fl-row.css

# If both exist → SAFE to remove from layout file
```

---

**Status**: Ready for execution
**Risk Level**: LOW for Phase 1, MEDIUM for Phase 2
**Expected Duration**: 2-4 hours for Phase 1, 4-6 hours for Phase 2
