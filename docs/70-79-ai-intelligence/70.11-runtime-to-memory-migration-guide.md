# Migrating from _runtime/ to Memory Coordination

**Document Type**: How-To Guide (Di√°taxis)
**Classification**: 70-79 AI Intelligence
**Authority**: jt_site Project Standard
**Status**: Production Ready
**Last Updated**: 2025-10-15

## üéØ Purpose

This guide helps agents migrate from INCORRECT `_runtime/` file-based coordination to CORRECT claude-flow MCP memory-based coordination.

## üö® Why This Migration is Critical

### The Problem with _runtime/

```yaml
_runtime_folder_issues:
  temporary_storage:
    problem: "Files deleted after 24h TTL"
    risk: "Other agents may not access files before deletion"

  race_conditions:
    problem: "Multiple agents reading/writing same files"
    risk: "Data corruption, lost coordination information"

  no_structure:
    problem: "Ad-hoc file naming without conventions"
    risk: "Agents cannot discover coordination data reliably"

  cleanup_conflicts:
    problem: "Auto-cleanup may delete active coordination data"
    risk: "Agent handoffs fail mid-coordination"
```

### Benefits of Memory Coordination

```yaml
memory_coordination_benefits:
  persistent_storage:
    benefit: "Data persists until explicitly deleted"
    advantage: "No race condition with auto-cleanup"

  structured_access:
    benefit: "Standardized namespace conventions"
    advantage: "Predictable data discovery patterns"

  cross_session_coordination:
    benefit: "Data available across agent sessions"
    advantage: "Long-running coordination workflows supported"

  conflict_prevention:
    benefit: "No file locking or concurrent access issues"
    advantage: "Multiple agents coordinate simultaneously"
```

## üîÑ Migration Pattern

### Step 1: Identify _runtime/ Usage

**Search Pattern**:
```bash
# Find agents using _runtime/ for coordination
grep -r "_runtime/" .claude/agents/*.md
```

**Common _runtime/ Anti-Patterns**:
```bash
# ‚ùå WRONG: File-based research output
echo "research findings" > _runtime/research-output.md

# ‚ùå WRONG: File-based analysis results
cat analysis.json > _runtime/css-analysis.json

# ‚ùå WRONG: File-based handoff data
write_file "_runtime/hugo-requirements.yaml" "$requirements"
```

### Step 2: Map to Memory Namespaces

For each `_runtime/` usage, map to appropriate memory namespace:

```yaml
migration_mapping:
  research_output:
    from: "_runtime/research-output.md"
    to: "jt_site/content/research/{timestamp}/findings.md"

  css_analysis:
    from: "_runtime/css-analysis.json"
    to: "jt_site/css/analysis/{timestamp}/duplicates.json"

  hugo_requirements:
    from: "_runtime/hugo-requirements.yaml"
    to: "jt_site/hugo/templates/requirements/{topic}/requirements.yaml"

  visual_baselines:
    from: "_runtime/screenshots/baseline.png"
    to: "jt_site/visual/baselines/{page}/screenshot.png"

  seo_recommendations:
    from: "_runtime/seo-recommendations.json"
    to: "jt_site/seo/optimization/{page}/recommendations.json"
```

### Step 3: Update Agent Behavioral Description

**Before (Incorrect)**:
```markdown
description: |
  I analyze CSS duplications and store results in _runtime/css-analysis.json
  for other agents to read before implementing consolidation.
```

**After (Correct)**:
```markdown
description: |
  I analyze CSS duplications and coordinate through claude-flow MCP memory tools.

  **Memory Coordination**:
  - I store CSS analysis results in: jt_site/css/analysis/{timestamp}/duplicates.json
  - I store extraction plans in: jt_site/css/extraction/{component}/plan.md
  - Other agents retrieve analysis from: jt_site/css/analysis/{timestamp}/*

  **Handoff Protocol**:
  When I complete CSS analysis, hugo-expert retrieves my findings to validate
  Hugo template impact. coder retrieves my extraction plan to implement
  consolidation while preserving page-specific CSS patterns.
```

### Step 4: Remove _runtime/ References from Hooks

**Before (Incorrect)**:
```yaml
hooks:
  pre: |
    echo "Starting analysis"
    mkdir -p _runtime/css-analysis
  post: |
    echo "Analysis complete"
    ls -la _runtime/css-analysis/*.json
```

**After (Correct)**:
```yaml
hooks:
  pre: |
    echo "üöÄ Starting CSS analysis: $TASK"
    npx claude-flow@alpha hooks pre-task --description "$TASK"
  post: |
    echo "‚úÖ Completed CSS analysis: $TASK"
    npx claude-flow@alpha hooks post-task --task-id "$TASK_ID"
```

**Key Change**: Memory coordination happens through behavioral descriptions, NOT hook commands.

## üéØ Complete Migration Example

### Agent: css-analyzer (Before)

```markdown
---
name: css-analyzer
type: coder
description: |
  I analyze CSS files for duplications and store results in _runtime/
  for other agents to process.
hooks:
  pre: |
    mkdir -p _runtime/css-analysis
  post: |
    echo "Analysis saved to _runtime/css-analysis.json"
---

# CSS Analyzer

I scan CSS files and output duplication reports to _runtime/.
Other agents read these files to implement consolidation.
```

### Agent: css-analyzer (After)

```markdown
---
name: css-analyzer
type: coder
description: |
  I analyze CSS files for duplications and coordinate through claude-flow
  MCP memory tools.

  **Memory Coordination**:
  - Store analysis: jt_site/css/analysis/{timestamp}/duplicates.json
  - Store extraction plans: jt_site/css/extraction/{component}/plan.md

  **Handoff Protocol**:
  hugo-expert retrieves analysis to validate Hugo template impact.
  coder retrieves extraction plans to implement consolidation.
hooks:
  pre: |
    echo "üöÄ Starting CSS analysis: $TASK"
    npx claude-flow@alpha hooks pre-task --description "$TASK"
  post: |
    echo "‚úÖ Completed CSS analysis: $TASK"
    npx claude-flow@alpha hooks post-task --task-id "$TASK_ID"
---

# CSS Analyzer

I analyze CSS files for duplications and coordinate results through
standardized memory namespaces for cross-agent collaboration.

## Memory Coordination Patterns

### What I Store
- CSS duplication analysis with line numbers and patterns
- Extraction plans for component-based consolidation
- Page-specific CSS preservation requirements

### Storage Locations
- **Analysis Results**: jt_site/css/analysis/{timestamp}/duplicates.json
- **Extraction Plans**: jt_site/css/extraction/{component}/plan.md
- **Preservation Rules**: jt_site/css/preservation/{page}/rules.yaml

### Who Retrieves My Data
- **hugo-expert**: Retrieves CSS analysis to validate Hugo template impact
- **coder**: Retrieves extraction plans to implement CSS consolidation
- **tester**: Retrieves preservation rules to validate visual regression
```

## üìã Migration Checklist

### For Each Agent Using _runtime/

- [ ] Identify all _runtime/ file operations in agent description
- [ ] Map each _runtime/ usage to appropriate memory namespace
- [ ] Update agent description with memory coordination patterns
- [ ] Document what agent stores and where
- [ ] Document what agent retrieves and from where
- [ ] Document handoff protocols with recipient agents
- [ ] Remove _runtime/ references from hooks
- [ ] Ensure hooks only use echo + npx claude-flow@alpha commands
- [ ] Test coordination with recipient agents
- [ ] Validate memory namespace accessibility

### Validation Steps

After migration, verify:

1. **No _runtime/ References**: `grep "_runtime/" agent.md` returns empty
2. **Memory Patterns Documented**: Agent description includes memory coordination section
3. **Handoff Protocols Clear**: Other agents know what namespaces to retrieve from
4. **Hooks Clean**: Only echo + npx claude-flow@alpha hooks commands
5. **Coordination Works**: Test agent can store and other agents can retrieve

## üéì Learning from Existing Patterns

### Study These Migrated Agents

**content-creator.md** (lines 285-303):
- ‚úÖ Excellent memory coordination patterns
- ‚úÖ Clear namespace organization
- ‚úÖ Documented handoff protocols
- ‚úÖ Clean hooks without file operations

**hugo-expert.md** (lines 318-325):
- ‚úÖ Technical coordination via memory
- ‚úÖ Hugo-specific namespace structure
- ‚úÖ Cross-agent collaboration documented
- ‚úÖ No _runtime/ references

### Anti-Pattern Examples to Avoid

```yaml
avoid_these_patterns:
  file_coordination:
    bad: "Store in _runtime/output.json"
    good: "Store in jt_site/content/research/{timestamp}/output.json"

  hardcoded_paths:
    bad: "_runtime/css/analysis.json"
    good: "jt_site/css/analysis/{timestamp}/duplicates.json"

  no_namespaces:
    bad: "memory key: 'research_results'"
    good: "namespace: jt_site/content/research/{timestamp}/results"

  hook_operations:
    bad: "hooks: pre: | mkdir -p _runtime/"
    good: "hooks: pre: | npx claude-flow@alpha hooks pre-task"
```

## üö® Common Migration Issues

### Issue 1: Timestamp Conflicts

**Problem**: Multiple agents using same timestamp
**Solution**: Use unique identifiers or agent-name prefixes

```yaml
solution:
  before: "jt_site/css/analysis/{timestamp}/"
  after: "jt_site/css/analysis/{agent_name}_{timestamp}/"
```

### Issue 2: Data Discovery

**Problem**: Recipient agent doesn't know what timestamp to use
**Solution**: Document coordination protocol clearly

```markdown
**Handoff Protocol**:
When I complete CSS analysis, I store results with timestamp: {current_timestamp}.
I announce completion via memory: jt_site/css/analysis/latest_timestamp = {timestamp}.
hugo-expert retrieves latest timestamp first, then accesses full analysis data.
```

### Issue 3: Cleanup Strategy

**Problem**: Memory data accumulating without cleanup
**Solution**: Document memory lifecycle and cleanup responsibility

```markdown
**Memory Lifecycle**:
- CSS analysis data persists for 7 days for retrospective analysis
- After sprint completion, sprint coordinator archives to permanent storage
- After 30 days, old sprint data automatically archived to cold storage
```

## üìñ Related Documentation

- **Primary Guide**: `70.08-agent-memory-coordination-patterns-how-to.md`
- **Quick Reference**: `70.09-agent-memory-coordination-quick-reference.md`
- **Solution Summary**: `70.10-memory-coordination-solution-summary.md`

## üÜò Migration Support

### When You Need Help

If migration is complex or unclear:

1. **Study Examples**: Review content-creator.md and hugo-expert.md patterns
2. **Consult Documentation**: Read comprehensive how-to guide (70.08)
3. **Request Expert Review**: Coordinate with claude-flow-specialist for validation

### Claude-Flow Expert Consultation

For agent configuration changes:
```javascript
Task("Claude-Flow Expert",
  "Review memory coordination migration for [agent_name]. Validate namespace patterns and handoff protocols.",
  "claude-flow-specialist")
```

---

**Migration Status**: Documentation complete, ready for agent migrations
**Next Step**: Identify agents using _runtime/ and apply this migration guide
