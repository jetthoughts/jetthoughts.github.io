# 60.13 Docker Test Precompilation Strategy

## Overview

This document explains the Docker test precompilation strategy for the JetThoughts Hugo site, addressing why we precompile assets outside Docker and how this optimizes our testing workflow.

## Problem Analysis

### Issue Identified (2025-09-16)
- **Symptom**: `bin/dtest` fails with "hugo: not found" error in Docker container
- **Root Cause**: Hugo is not installed in the Docker test container, but tests attempt to run Hugo inside container
- **Impact**: Complete Docker test pipeline failure, preventing comprehensive test validation

### Previous Working State
- `bin/test` was recently fixed by adding `relativeURLs = true` to `config/test/hugo.toml`
- Host-based tests work correctly with this configuration
- Docker tests failed because they assumed Hugo availability inside container

## Docker Test Architecture

### Current Design Philosophy: PRECOMPILED_ASSETS Strategy

We deliberately use a **precompiled assets approach** for Docker tests to avoid:

1. **Performance Overhead**
   - Hugo build time: ~13 seconds for 792 pages + 7034 processed images
   - Memory usage: Hugo requires significant memory for large content sites
   - CPU overhead: Build processing multiplied across multiple test runs

2. **Docker Resource Constraints**
   - Container memory limits: 2GB for test runner
   - CPU limits: 4.0 cores allocated
   - Network overhead: Downloading Hugo binary and dependencies

3. **Build Complexity**
   - Go toolchain requirements for Hugo installation
   - Node.js dependencies for asset pipeline
   - Ruby dependencies for test framework
   - Dependency version conflicts between build and runtime environments

4. **Test Speed Optimization**
   - Test feedback loops: Faster with precompiled assets
   - Parallel test execution: No build contention
   - CI/CD efficiency: Reduced total pipeline time

### Implementation Strategy

#### Phase 1: Precompilation (Host Environment)
```bash
# bin/dtest executes on host (with Hugo available)
hugo --noBuildLock \
  --buildDrafts \
  --environment test \
  --gc \
  --cleanDestinationDir \
  --destination _dest/public-dtest \
  --logLevel warn \
  --baseURL="http://localhost:1314"
```

#### Phase 2: Test Execution (Docker Environment)
```yaml
# Docker compose service 't' configuration
t:
  image: jetthoughts.com-test:1.0.0
  working_dir: /app
  command: bin/test
  volumes:
    - ..:/app:delegated  # Includes precompiled _dest/public-dtest
  environment:
    HUGO_DEFAULT_PATH: "_dest/public-dtest"  # Points to precompiled build
```

## Technical Implementation

### Current Workflow
1. **Host Precompilation**: `bin/dtest` runs Hugo on host system
2. **Asset Transfer**: Precompiled `_dest/public-dtest` mounted into Docker container
3. **Test Execution**: Ruby tests serve precompiled assets via Rack static server
4. **Validation**: Capybara/system tests validate rendered HTML

### Configuration Files

#### Hugo Test Configuration
```toml
# config/test/hugo.toml
baseURL = "http://localhost:1314/"
relativeURLs = true  # CRITICAL: Enables relative URL generation for Docker environment
environment = "test"
```

#### Docker Environment Variables
```yaml
environment:
  HUGO_DEFAULT_PATH: "_dest/public-dtest"  # Precompiled asset path
  HUGO_CACHEDIR: "/tmp/hugo_cache_dtest"   # Docker cache optimization
```

#### Test Helper Configuration
```ruby
# test/support/hugo_helpers.rb
class Hugo
  def initialize(path: ENV.fetch("HUGO_DEFAULT_PATH", "_dest/public-test"))
    @destination = Pathname.new(path).expand_path
  end

  def precompile(port:)
    # Only runs if Hugo binary available (host environment)
    # Docker environment skips this, uses precompiled assets
  end
end
```

## Benefits of Precompilation Strategy

### 1. Performance Optimization
- **Build Time**: Single 13-second build vs multiple builds per test run
- **Memory Efficiency**: Hugo memory usage isolated to host environment
- **Test Speed**: Ruby tests start immediately with precompiled assets

### 2. Resource Management
- **Docker Simplicity**: Test container only needs Ruby runtime, not Go/Hugo toolchain
- **Memory Allocation**: Full 2GB available for test execution, not build processes
- **CPU Utilization**: All 4 cores available for test parallelization

### 3. Reliability Improvements
- **Dependency Isolation**: Build and test dependencies separated
- **Consistent Environment**: Same Hugo version across local/CI environments
- **Error Isolation**: Build failures vs test failures clearly separated

### 4. CI/CD Optimization
- **Pipeline Efficiency**: Parallel build and test preparation
- **Cache Effectiveness**: Precompiled assets cached between test runs
- **Resource Scaling**: Build and test resources independently scalable

## Implementation Guidelines

### For Developers
1. **Local Development**: Always run `bin/dtest` (not `bin/docked t`)
2. **Asset Changes**: Requires host rebuild before Docker tests
3. **Content Changes**: Automatically included in precompilation

### For CI/CD
1. **Build Stage**: Run Hugo precompilation on build agents
2. **Test Stage**: Use precompiled assets in test containers
3. **Artifact Management**: Cache precompiled assets between stages

### For Hugo Configuration Changes
1. **Test Configuration**: Update `config/test/hugo.toml` affects both host and Docker
2. **URL Generation**: `relativeURLs = true` essential for Docker environment
3. **Performance Settings**: Test-specific optimizations in config

## Troubleshooting

### Common Issues

#### "hugo: not found" in Docker
- **Cause**: Test code attempting to run Hugo inside Docker container
- **Solution**: Ensure `HUGO_DEFAULT_PATH` points to precompiled assets
- **Prevention**: Use `Hugo#precompile` only when Hugo binary available

#### Relative URL Issues
- **Cause**: Missing `relativeURLs = true` in test configuration
- **Solution**: Add `relativeURLs = true` to `config/test/hugo.toml`
- **Validation**: Check generated HTML uses relative paths

#### Missing Assets in Docker
- **Cause**: Precompilation step skipped or failed
- **Solution**: Run `bin/dtest` (includes precompilation) instead of `bin/docked t`
- **Validation**: Verify `_dest/public-dtest` directory exists with content

### Diagnostic Commands
```bash
# Check precompiled assets exist
ls -la _dest/public-dtest/

# Verify Hugo binary availability (host)
which hugo

# Check Docker environment variables
bin/docked sh -c 'echo $HUGO_DEFAULT_PATH'

# Validate test configuration
hugo config --environment test
```

## Future Considerations

### Potential Optimizations
1. **Asset Caching**: Implement more aggressive caching strategies
2. **Incremental Builds**: Hugo watch mode for development
3. **Build Parallelization**: Parallel asset and content processing

### Alternative Approaches Considered
1. **Hugo in Docker**: Rejected due to complexity and performance overhead
2. **Asset Bundling**: Considered but Hugo's asset pipeline sufficient
3. **Multi-stage Builds**: Evaluated but precompilation approach simpler

## Related Documentation
- `bin/dtest` - Docker test runner script
- `config/test/hugo.toml` - Test environment Hugo configuration
- `test/support/hugo_helpers.rb` - Ruby test helpers for Hugo integration
- `.dev/compose.yml` - Docker compose configuration for test services

## Solution Implementation (2025-09-16)

### Fix Applied: Docker Environment Detection in Hugo Helpers

**Problem Resolved**: Docker tests failing with "hugo: not found" error
**Solution**: Implemented Docker environment detection in `test/support/hugo_helpers.rb`

#### Technical Implementation
```ruby
# Added to Hugo class in test/support/hugo_helpers.rb
def docker_environment?
  ENV["HUGO_DEFAULT_PATH"]&.include?("dtest") || File.exist?("/.dockerenv")
end

def precompile(port:)
  # Skip Hugo execution in Docker environment - use precompiled assets
  return self if docker_environment?

  # Original Hugo execution logic for host environment...
end
```

#### Validation Results
- **Unit Tests**: AssetUrlValidationTest and SeoSchemaTest now pass in Docker (6 tests, 2349 assertions, 0 failures)
- **Host Tests**: Confirmed no regression in host environment (same tests pass)
- **Performance**: Docker tests use precompiled assets (13-second build done once on host)
- **Architecture**: Clean separation between build (host) and test (Docker) environments

### Success Metrics
- **Build Time**: Single 13-second Hugo build vs multiple builds eliminated
- **Docker Memory**: Full 2GB available for tests (Hugo overhead eliminated)
- **Test Speed**: Unit tests complete in ~0.7 seconds in Docker
- **Error Resolution**: "hugo: not found" error completely eliminated

## Change Log
- **2025-09-16**: Initial documentation creation
- **2025-09-16**: Identified Hugo missing in Docker container issue
- **2025-09-16**: Documented precompilation strategy rationale
- **2025-09-16**: **SOLUTION IMPLEMENTED**: Docker environment detection successfully deployed
- **2025-09-16**: Validated unit tests passing in both Docker and host environments

---

**Authority**: Technical Architecture Decision
**Compliance**: MANDATORY for all Docker test modifications
**Review**: Required before any changes to Docker test pipeline
