---
Global Reference: /knowledge/50.01-global-file-management.md
Authority: Secondary (Extends Global Standards)
Last Synced: 2024-01-19
---

# Hugo Watch Mode for Testing

## Overview

The Hugo watch mode service automatically rebuilds the site to `_dest/public-dtest/` whenever files change, providing instant feedback during development and testing.

## Features

- âœ… **Automatic Rebuilds**: Detects file changes and rebuilds immediately
- âœ… **In-Memory Rendering**: Uses `--renderToMemory` for faster builds
- âœ… **Production Environment**: Builds with production settings for accurate testing
- âœ… **Dedicated Test Output**: Outputs to `_dest/public-dtest/` directory
- âœ… **Fast Polling**: 500ms poll interval for quick change detection
- âœ… **Resource Optimized**: Limited CPU/memory for efficient operation

## Quick Start

### Using the convenience script

```bash
# Start Hugo watch mode (follows logs)
bin/hugo-watch

# Start in background
bin/hugo-watch -d

# View logs for background mode
docker compose -f .dev/compose.yml logs -f hugo-watch
```

### Using Docker Compose directly

```bash
# Start the service
docker compose -f .dev/compose.yml up -d hugo-watch

# Check status
docker compose -f .dev/compose.yml ps hugo-watch

# View logs
docker compose -f .dev/compose.yml logs -f hugo-watch

# Stop the service
docker compose -f .dev/compose.yml stop hugo-watch
```

## Service Configuration

The `hugo-watch` service in `.dev/compose.yml` is configured with:

```yaml
hugo-watch:
  image: hugomods/hugo:exts-non-root-0.149.1
  ports:
    - '1314:1314'  # Different port from dev server
  command: >
    hugo server 
    --bind 0.0.0.0 
    --port 1314
    --destination _dest/public-dtest
    --environment production
    --watch 
    --disableFastRender 
    --gc 
    --poll 500ms
    --renderToMemory
    --noHTTPCache
    --forceSyncStatic
```

## Integration with Tests

The watch mode works seamlessly with the test runner:

```bash
# Terminal 1: Start Hugo watch mode
bin/hugo-watch

# Terminal 2: Run tests (uses _dest/public-dtest/)
docker compose -f .dev/compose.yml run --rm t

# Or run specific tests
docker compose -f .dev/compose.yml run --rm t bundle exec ruby test/sync/test_sync_articles.rb
```

## Performance Benefits

1. **No Manual Rebuilds**: Eliminates need for `docker compose run build` before tests
2. **Instant Updates**: Changes reflected in ~500ms
3. **Memory Efficiency**: In-memory rendering reduces disk I/O
4. **Parallel Workflow**: Tests can run while Hugo rebuilds

## Micro-Refactoring Workflow

Perfect for the 3-line change micro-refactoring approach:

1. Start Hugo watch mode: `bin/hugo-watch -d`
2. Make your 3-line change
3. Hugo automatically rebuilds (~500ms)
4. Run focused test: `docker compose -f .dev/compose.yml run --rm t [test_file]`
5. Get feedback in <5 seconds total

## Monitoring

### Health Check

The service includes a health check that verifies Hugo is responding:

```bash
# Check health status
docker compose -f .dev/compose.yml ps hugo-watch
```

### Resource Usage

Monitor CPU and memory usage:

```bash
docker stats $(docker compose -f .dev/compose.yml ps -q hugo-watch)
```

### Build Performance

View build times in logs:

```bash
docker compose -f .dev/compose.yml logs hugo-watch | grep "built in"
```

## Troubleshooting

### Service won't start

```bash
# Check logs for errors
docker compose -f .dev/compose.yml logs hugo-watch

# Verify port 1314 is available
lsof -i :1314

# Restart the service
docker compose -f .dev/compose.yml restart hugo-watch
```

### Changes not detected

```bash
# Verify polling is working
docker compose -f .dev/compose.yml logs hugo-watch | tail -20

# Check file permissions
ls -la _dest/public-dtest/

# Force rebuild
docker compose -f .dev/compose.yml restart hugo-watch
```

### High CPU usage

```bash
# Adjust poll interval in compose.yml
# Change: --poll 500ms
# To: --poll 1s
```

## Advanced Usage

### Custom Watch Patterns

Modify the command in `compose.yml` to watch specific directories:

```yaml
command: >
  hugo server 
  --bind 0.0.0.0 
  --port 1314
  --destination _dest/public-dtest
  --environment production
  --watch 
  --watchDir content
  --watchDir layouts
  # ... rest of options
```

### Integration with CI/CD

The watch mode can be used in CI for progressive testing:

```yaml
# .github/workflows/test.yml
- name: Start Hugo watch mode
  run: docker compose -f .dev/compose.yml up -d hugo-watch

- name: Wait for Hugo
  run: |
    until docker compose -f .dev/compose.yml ps hugo-watch | grep -q "healthy"; do
      sleep 1
    done

- name: Run tests
  run: docker compose -f .dev/compose.yml run --rm t
```

## Benefits Summary

- **âš¡ Speed**: 500ms rebuilds vs 3-8s manual builds
- **ðŸ”„ Automation**: No manual build commands needed
- **ðŸ’¾ Efficiency**: In-memory rendering reduces I/O
- **ðŸŽ¯ Focus**: Dedicated test environment (_dest/public-dtest/)
- **ðŸ“Š Production**: Tests against production config
- **ðŸ”§ Integration**: Works with existing test infrastructure
