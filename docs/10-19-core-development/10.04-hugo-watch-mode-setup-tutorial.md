# Hugo Watch Mode Setup for Micro-Refactoring

This documentation describes the Docker Compose setup with Hugo watch mode optimized for micro-refactoring workflows.

## Overview

The watch mode setup provides:

- **Hugo service** running in watch mode with volume mounts
- **Pre-rendered content** available to test container via shared volumes
- **Shared memory volume** for instant updates between services
- **Health checks** to ensure Hugo readiness before tests
- **Incremental build strategy** with read-only mounts and tmpfs optimization
- **Intelligent file watching** with selective test execution
- **Micro-refactoring support** with fast feedback loops

## Architecture

### Services

1. **hugo-watch**: Hugo server with optimized watch mode
   - Renders to memory for fastest rebuilds
   - Uses fast render mode with polling
   - Shared volume output for other services

2. **file-watcher**: Intelligent file change detection
   - Uses inotify for efficient file monitoring
   - Triggers selective tests based on file type
   - Supports debouncing to batch changes

3. **test-runner**: Test execution with pre-rendered content
   - Read-only access to prevent pollution
   - Uses Hugo's memory output for testing
   - Parallel test execution support

### Volume Strategy

- **Source mount**: Read-only to prevent test pollution
- **Hugo memory**: Shared volume for instant content updates
- **Cache volume**: Persistent Hugo cache for performance
- **Tmpfs**: In-memory filesystem for temporary files

## Quick Start

### 1. Validate Setup

```bash
# Check if everything is configured correctly
./bin/validate-watch-setup
```

### 2. Start Watch Environment

```bash
# Start all services in background
./bin/watch-compose up -d

# Or start with logs visible
./bin/watch-compose up
```

### 3. Monitor Services

```bash
# Check service status
./bin/watch-compose status

# Follow all logs
./bin/watch-compose logs -f

# Follow Hugo logs only
./bin/watch-compose logs-hugo -f

# Follow file watcher logs
./bin/watch-compose logs-watcher -f
```

### 4. Development Workflow

1. Make small changes (≤3 lines for micro-refactoring)
2. File watcher detects changes automatically
3. Selective tests run based on changed files
4. Hugo rebuilds content instantly
5. View results at <http://localhost:1313>

### 5. Manual Testing

```bash
# Run tests manually
./bin/watch-compose test

# Open shell in test environment
./bin/watch-compose shell

# Open shell in Hugo container
./bin/watch-compose hugo-shell
```

### 6. Stop Environment

```bash
# Stop services
./bin/watch-compose down

# Clean up everything (containers, volumes, data)
./bin/watch-compose clean
```

## File Watching Intelligence

The file watcher uses intelligent strategies based on file types:

### Content Changes (`content/*`)

- Runs content validation tests
- Quick content-focused test suite

### Layout Changes (`layouts/*`, `themes/*`)

- Runs rendering and template tests
- Validates template compilation

### Configuration Changes (`config/*`, `*.toml`)

- Runs full test suite
- Validates configuration integrity

### Asset Changes (`static/*`, `assets/*`)

- Runs asset and performance tests
- Validates asset compilation

### Data Changes (`data/*`)

- Runs data-dependent tests
- Validates data processing

### Test Files (`test/*`, `spec/*`)

- Runs the specific test file
- Targeted test execution

## Performance Optimizations

### Hugo Optimizations

- `--renderToMemory`: Fastest possible rebuilds
- `--disableFastRender=false`: Enable fast render mode
- `--gc`: Garbage collection for memory efficiency
- `--poll 500ms`: Optimized polling interval
- `--noHTTPCache`: Prevent caching issues in development

### Docker Optimizations

- **Read-only mounts**: Prevent test pollution
- **Tmpfs**: In-memory temp files for performance
- **Delegated volumes**: Optimized for macOS performance
- **Resource limits**: Prevent resource contention
- **Health checks**: Ensure service readiness

### File Watching Optimizations

- **inotify**: Efficient kernel-level file watching
- **Debouncing**: Batch multiple changes (0.5s delay)
- **Extension filtering**: Only watch relevant file types
- **Path filtering**: Focus on important directories

## Micro-Refactoring Best Practices

### Optimal Change Size

- Keep changes ≤3 lines for fastest feedback
- Use selective testing to focus validation
- Make atomic changes that can be easily reverted

### Workflow Pattern

1. Start watch environment: `./bin/watch-compose up -d`
2. Make small change (≤3 lines)
3. Watch automatic test execution
4. Fix issues immediately if tests fail
5. Repeat with next small change

### Debugging Failed Tests

```bash
# Check what tests ran
./bin/watch-compose logs-watcher

# Run specific test manually
./bin/watch-compose shell
bundle exec ruby -Itest test/specific_test.rb

# Check Hugo output
./bin/watch-compose logs-hugo
```

## Configuration Files

### docker-compose.test.yml

Complete Docker Compose configuration with:

- Service definitions for Hugo, file watcher, and test runner
- Volume configurations for shared memory and caching
- Environment variables for optimization
- Health checks and resource limits

### bin/watch-test

Intelligent file watching script with:

- inotify-based file change detection
- Selective test execution strategies
- Debouncing and performance optimization
- Comprehensive logging and error handling

### bin/watch-compose

Docker Compose management script with:

- Service lifecycle management
- Log viewing and monitoring
- Interactive shell access
- Health checking and diagnostics

### bin/validate-watch-setup

Setup validation script with:

- Configuration syntax checking
- System requirements verification
- Performance optimization validation
- Integration testing

### config/development/hugo.toml

Enhanced Hugo development configuration with:

- Watch mode optimizations
- Cache control headers
- Performance-focused settings

## Troubleshooting

### Hugo Not Starting

```bash
# Check Hugo container logs
./bin/watch-compose logs-hugo

# Verify Hugo configuration
docker compose -f docker-compose.test.yml config

# Check Hugo health
./bin/watch-compose health
```

### File Watcher Not Detecting Changes

```bash
# Check file watcher logs
./bin/watch-compose logs-watcher

# Verify inotify is working
./bin/watch-compose shell
inotifywait -m -r --format '%w%f %e' -e modify content/
```

### Tests Not Running

```bash
# Check test runner logs
./bin/watch-compose logs-test

# Run tests manually
./bin/watch-compose test

# Verify test dependencies
./bin/watch-compose shell
bundle exec rake test
```

### Performance Issues

```bash
# Check resource usage
docker stats

# Check Hugo memory usage
./bin/watch-compose logs-hugo | grep memory

# Optimize Docker resources
# Increase Docker Desktop memory allocation to 4GB+
```

## Environment Variables

You can customize the behavior with environment variables:

```bash
# File watching configuration
export WATCH_PATHS="content,layouts,static,data,config,assets"
export WATCH_EXTENSIONS="md,html,toml,yaml,yml,js,css,scss"
export DEBOUNCE_DELAY="0.5"

# Testing configuration
export TEST_ON_CHANGE="true"
export MAX_PARALLEL_TESTS="4"

# Hugo configuration
export HUGO_ENVIRONMENT="development"
export HUGO_FAST_RENDER="true"
export HUGO_NUMWORKERMULTIPLIER="6"
```

## Advanced Usage

### Custom Test Strategies

You can extend the test strategies in `bin/watch-test`:

```bash
# Add custom test strategy
get_test_strategy() {
    case "$changed_file" in
        custom/*)
            echo "custom"
            ;;
        # ... existing patterns
    esac
}

# Add custom test execution
run_tests() {
    case "$strategy" in
        custom)
            bundle exec rake test:custom
            ;;
        # ... existing strategies
    esac
}
```

### Integration with CI/CD

The watch mode setup can be integrated with CI/CD pipelines:

```yaml
# GitHub Actions example
- name: Validate Hugo watch setup
  run: ./bin/validate-watch-setup

- name: Start Hugo watch mode
  run: ./bin/watch-compose up -d

- name: Run integration tests
  run: ./bin/watch-compose test

- name: Check Hugo health
  run: ./bin/watch-compose health
```

## Support

For issues and questions:

1. Run validation: `./bin/validate-watch-setup`
2. Check service health: `./bin/watch-compose health`
3. Review logs: `./bin/watch-compose logs -f`
4. Consult troubleshooting section above

---

**Note**: This setup is optimized for development and micro-refactoring workflows. For production builds, use the standard `bin/build` and `bin/test` scripts.
