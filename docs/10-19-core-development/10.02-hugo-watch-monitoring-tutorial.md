# Hugo Watch Monitoring Guide

## Overview

The Hugo Watch monitoring system provides comprehensive diagnostic tools for troubleshooting and monitoring the Hugo watch service. This includes both automated status monitoring and enhanced service management.

## Tools

### 1. `bin/hugo-watch-status` - Comprehensive Monitoring Script

A comprehensive diagnostic tool that provides detailed information about the Hugo watch service status.

#### Features

- **Service Status**: Current Docker container status and health
- **Container Metrics**: Resource usage (CPU, memory) and restart count
- **Health Check Status**: Real-time health check results
- **Build Output Validation**: Checks for `public-dtest` directory and key files
- **Log Analysis**: Last 10 log lines with color-coded output
- **Connectivity Testing**: Verifies server accessibility and response time
- **Troubleshooting Suggestions**: Context-aware suggestions based on current status

#### Usage

```bash
# Run comprehensive status check
bin/hugo-watch-status
```

#### Sample Output

```
🔍 Hugo Watch Status Monitor
════════════════════════════════

📊 Service Status:
NAME               STATE     STATUS
dev-hugo-watch-1   running   Up 5 minutes (healthy)
✅ Service is healthy

🔄 Container Restart Information:
  Restart Count: 0
  Started At: 2025-09-12T10:06:35.618604885Z

📈 Resource Usage:
  CPU%    MEM USAGE / LIMIT     MEM%
28.87%    777.9MiB / 2GiB     37.99%

🏥 Health Check Status:
✅ Healthy

📁 Build Output Status:
✅ public-dtest directory exists
  Last Modified: 2025-09-12 12:08:37
  File Count: 10315 files
  Directory Size: 1.0G
📄 Key Files Check:
  ✅ index.html (138501 bytes)
  ✅ CSS directory (19 files)
  ✅ JS directory (2 files)
```

### 2. Enhanced `bin/hugo-watch` - Improved Service Management

The Hugo watch script has been enhanced to handle cases where the service is already running.

#### New Features

- **Existing Service Detection**: Automatically detects if the service is already running
- **Interactive Restart Prompt**: Asks user whether to restart or use existing service
- **Force Restart Option**: `--force` flag bypasses interactive prompt
- **Smart Cleanup**: Only stops services that were started by the script
- **Background Mode**: `-d` flag runs in background without following logs

#### Usage Options

```bash
# Start with logs (interactive)
bin/hugo-watch

# Start in background
bin/hugo-watch -d

# Force restart if already running
bin/hugo-watch --force

# Force restart in background
bin/hugo-watch --force -d
```

#### Behavior with Already Running Service

When the service is already running:

1. **Interactive Mode** (default): Prompts user to restart or use existing
2. **Force Mode** (`--force`): Automatically restarts the service
3. **Smart Cleanup**: Only stops services if script started them or force restart was used

## Docker Compose Configuration

The Hugo watch service is configured with:

### Service Definition

```yaml
hugo-watch:
  image: hugomods/hugo:exts-non-root-0.149.1
  working_dir: /app
  ports:
    - '1314:1314'  # Different port from dev server
  command: >
    hugo server
    --bind 0.0.0.0 
    --port 1314
    --destination public-dtest
    --environment production
    --watch 
    --disableFastRender 
    --poll 1s
    --noHTTPCache
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1314/"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s
```

### Key Features

- **Production Environment**: Builds with production settings
- **File Watching**: 1-second poll interval for fast change detection
- **Health Monitoring**: Built-in health checks every 30 seconds
- **Resource Limits**: CPU and memory constraints for efficiency
- **Output Directory**: Dedicated `public-dtest/` for testing

## Troubleshooting Workflow

### 1. Quick Status Check

```bash
# Get comprehensive status overview
bin/hugo-watch-status
```

### 2. Common Issues and Solutions

#### Service Not Starting

```bash
# Check logs for errors
docker compose -f .dev/compose.yml logs hugo-watch

# Restart with force flag
bin/hugo-watch --force
```

#### Build Output Missing

```bash
# Wait for initial build (30-60 seconds)
# Monitor logs for build completion
docker compose -f .dev/compose.yml logs -f hugo-watch

# Force rebuild if needed
docker compose -f .dev/compose.yml restart hugo-watch
```

#### High Resource Usage

```bash
# Check resource usage
bin/hugo-watch-status

# Consider adjusting polling interval in compose.yml
# Change: --poll 1s
# To: --poll 2s
```

### 3. Manual Service Management

```bash
# Start service
docker compose -f .dev/compose.yml up -d hugo-watch

# Stop service
docker compose -f .dev/compose.yml stop hugo-watch

# Restart service
docker compose -f .dev/compose.yml restart hugo-watch

# View logs
docker compose -f .dev/compose.yml logs -f hugo-watch
```

## Integration with Development Workflow

### Micro-Refactoring Workflow

The Hugo watch service is perfect for micro-refactoring (≤3 line changes):

1. Start Hugo watch: `bin/hugo-watch -d`
2. Make 3-line change
3. Hugo rebuilds automatically (~1-2 seconds)
4. Run targeted tests: `docker compose -f .dev/compose.yml run --rm t`
5. Get feedback in <5 seconds total

### Continuous Integration

```bash
# In CI/CD pipeline
bin/hugo-watch --force -d  # Start in background
bin/hugo-watch-status      # Verify service is healthy
# Run tests...
```

## Monitoring Automation

### Scheduled Health Checks

```bash
# Add to cron for periodic monitoring
*/5 * * * * cd /path/to/project && bin/hugo-watch-status > /tmp/hugo-status.log
```

### Alert Integration

The status script returns appropriate exit codes:

- `0`: All systems operational
- `1`: Service issues detected

```bash
# Example alert script
if ! bin/hugo-watch-status >/dev/null 2>&1; then
    echo "ALERT: Hugo watch service issues detected" | mail -s "Hugo Service Alert" admin@example.com
fi
```

## Performance Optimization

### Resource Monitoring

Use `bin/hugo-watch-status` to monitor:

- CPU usage trends
- Memory consumption
- Build times (in logs)
- Container restart frequency

### Optimization Tips

1. **Adjust Poll Interval**: Increase `--poll` value if CPU usage is high
2. **Resource Limits**: Adjust CPU/memory limits in compose.yml
3. **Exclude Directories**: Use `.gitignore` patterns to exclude unnecessary files
4. **Cache Management**: Monitor Hugo cache directory size

## Advanced Usage

### Custom Health Checks

Extend the monitoring script for project-specific checks:

```bash
# Check for specific files
if [ -f "public-dtest/custom-endpoint/index.html" ]; then
    echo "✅ Custom endpoint available"
fi

# Validate content
if grep -q "expected-content" public-dtest/index.html; then
    echo "✅ Content validation passed"
fi
```

### Log Analysis

```bash
# Search for specific patterns in logs
docker compose -f .dev/compose.yml logs hugo-watch | grep "ERROR\|WARNING"

# Monitor build times
docker compose -f .dev/compose.yml logs hugo-watch | grep "Built in"
```

---

## Quick Reference Commands

| Command | Purpose |
|---------|---------|
| `bin/hugo-watch-status` | Comprehensive status check |
| `bin/hugo-watch` | Start with logs (interactive) |
| `bin/hugo-watch -d` | Start in background |
| `bin/hugo-watch --force` | Force restart |
| `docker compose -f .dev/compose.yml logs -f hugo-watch` | Follow logs |
| `docker compose -f .dev/compose.yml ps hugo-watch` | Quick status |
| `docker compose -f .dev/compose.yml restart hugo-watch` | Manual restart |

## Support

For issues and questions:

1. Run `bin/hugo-watch-status` for diagnostic information
2. Check service logs: `docker compose -f .dev/compose.yml logs hugo-watch`
3. Review this documentation for troubleshooting steps
4. Consult the main Hugo documentation for Hugo-specific issues
