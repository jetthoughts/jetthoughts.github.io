# 60.12 Asset URL and Port Strategy Learnings

## üìö Critical Learning: Asset URL Generation in Hugo Testing

### Problem Statement
Screenshot tests were failing with 77-82% differences due to asset URL generation inconsistencies between different test environments (bin/test vs bin/dtest).

### Root Causes Identified

1. **SVG Partial Issue**: The `themes/beaver/layouts/partials/svgiw.html` was using `Permalink | relURL` instead of `RelPermalink`
2. **Port Strategy Inconsistency**:
   - bin/test uses dynamic port assignment from Capybara
   - bin/dtest uses fixed port 1314
   - Both need to work correctly

3. **URL Generation Methods**:
   - `canonifyURLs = true` - Makes all relative URLs absolute
   - `relativeURLs = true` - Makes all URLs relative (better for testing)
   - These two settings conflict and cannot be used together

### Solution Applied

#### Phase 1: Support Both Port Strategies
```ruby
# test/application_system_test_case.rb
if ENV["PRECOMPILED_ASSETS"]
  # Use fixed port for precompiled assets (performance optimization)
  Capybara.server_port = ENV.fetch("TEST_SERVER_PORT") { 1314 }
else
  # Use dynamic port assignment for flexibility
  hugo_builder.precompile(port: Capybara.current_session.server.port)
end
```

#### Phase 2: Use Relative URLs in Test Environment
```toml
# config/test/hugo.toml
baseURL = "/"
relativeURLs = true  # Instead of canonifyURLs = true
```

### Key Principles

1. **Conservative Changes**: Make smallest possible changes, test after each
2. **Support Both Scenarios**: Must support both PRECOMPILED_ASSETS and dynamic ports
3. **Prefer Relative URLs**: More flexible for testing across different environments
4. **Use Hugo's Built-in Features**: Don't create custom solutions when Hugo provides native support

### Testing Strategy

1. **Unit Tests**: Validate asset URL generation
2. **System Tests**: Verify screenshots match with proper asset loading
3. **Performance Tests**: Ensure no regression in build times
4. **Cross-Environment**: Test both bin/test and bin/dtest

### Anti-Patterns to Avoid

‚ùå **Test Masking**: Never increase tolerance thresholds to hide failures
‚ùå **Hardcoded Ports**: Avoid hardcoding port numbers in tests
‚ùå **Complex Solutions**: Don't build custom URL rewriting when Hugo has native support
‚ùå **Ignoring Root Cause**: Fix the actual problem, not symptoms

### Future Improvements

1. **Full Relative URL Migration**: Transition all environments to use relative URLs
2. **Unified Port Strategy**: Consider standardizing on dynamic ports for all test scenarios
3. **Asset Pipeline Optimization**: Leverage Hugo's asset fingerprinting more effectively

### References

- Hugo Documentation: [URL Management](https://gohugo.io/content-management/urls/)
- Hugo Configuration: `relativeURLs` vs `canonifyURLs`
- Capybara Dynamic Port Assignment
- Docker Test Environment (bin/dtest) Configuration

## Compliance

This document follows:
- Johnny Decimal: 60.12 (60-69 Knowledge Management, 12 = Asset Strategy)
- Di√°taxis: Explanation (understanding concepts)
- Zero-duplication: Single source of truth for asset URL learnings