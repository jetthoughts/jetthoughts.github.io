{{/*
  WebP Responsive Image Shortcode
  Automatically converts images to WebP with fallback support for maximum compatibility and performance
  
  Usage: {{< img-webp src="image.jpg" alt="Description" width="800" >}}
  
  Features:
  - Automatic WebP conversion with original format fallback
  - Responsive sizing with configurable breakpoints
  - Lazy loading with proper accessibility
  - Optimized for Core Web Vitals (LCP)
*/}}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $width := .Get "width" | default "800" -}}
{{- $class := .Get "class" | default "" -}}
{{- $loading := .Get "loading" | default "lazy" -}}

{{- if $src -}}
  {{/* Get the original image resource */}}
  {{- $img := resources.Get $src -}}
  
  {{- if $img -}}
    {{/* Process images with caching for performance */}}
    {{- $webp := $img.Resize (printf "%sx webp" $width) -}}
    {{- $fallback := $img.Resize (printf "%sx" $width) -}}
    
    {{/* Generate responsive sizes */}}
    {{- $webp800 := $img.Resize "800x webp" -}}
    {{- $webp600 := $img.Resize "600x webp" -}}
    {{- $webp400 := $img.Resize "400x webp" -}}
    {{- $fallback800 := $img.Resize "800x" -}}
    {{- $fallback600 := $img.Resize "600x" -}}
    {{- $fallback400 := $img.Resize "400x" -}}
    
    <picture class="{{ $class }}">
      <source 
        srcset="{{ $webp400.RelPermalink }} 400w, {{ $webp600.RelPermalink }} 600w, {{ $webp800.RelPermalink }} 800w" 
        sizes="(max-width: 400px) 400px, (max-width: 600px) 600px, 800px"
        type="image/webp">
      <source 
        srcset="{{ $fallback400.RelPermalink }} 400w, {{ $fallback600.RelPermalink }} 600w, {{ $fallback800.RelPermalink }} 800w" 
        sizes="(max-width: 400px) 400px, (max-width: 600px) 600px, 800px"
        type="{{ $fallback.MediaType.Type }}">
      <img 
        src="{{ $fallback.RelPermalink }}" 
        alt="{{ $alt }}" 
        width="{{ $fallback.Width }}" 
        height="{{ $fallback.Height }}"
        loading="{{ $loading }}"
        decoding="async">
    </picture>
  {{- else -}}
    {{/* Fallback for missing images */}}
    <img src="{{ $src }}" alt="{{ $alt }}" loading="{{ $loading }}">
  {{- end -}}
{{- end -}}