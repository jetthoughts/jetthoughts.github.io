{{/* Contextual Internal Links
  Provides topic-specific internal link suggestions */}}
{{ $currentTags := .Params.tags }}
{{ $blogPosts := where .Site.RegularPages "Section" "blog" }}

{{/* Create topic clusters based on tags */}}
{{ $topicClusters := dict 
  "Ruby on Rails" (dict 
    "keywords" (slice "ruby" "rails" "activerecord" "erb" "gem" "bundler")
    "color" "#cc0000"
    "icon" "💎"
  )
  "JavaScript & Frontend" (dict 
    "keywords" (slice "javascript" "react" "typescript" "frontend" "vue" "angular" "node")
    "color" "#f7df1e"
    "icon" "🚀"
  )
  "Development Practices" (dict 
    "keywords" (slice "testing" "tdd" "agile" "ci" "deployment" "devops" "automation")
    "color" "#28a745"
    "icon" "🛠️"
  )
  "Startup & Management" (dict 
    "keywords" (slice "startup" "management" "cto" "leadership" "team" "hiring" "strategy")
    "color" "#6f42c1"
    "icon" "📈"
  )
  "Quality & Testing" (dict 
    "keywords" (slice "qa" "testing" "quality" "automation" "performance" "security")
    "color" "#17a2b8"
    "icon" "🧪"
  )
}}

{{/* Find relevant topic clusters for current post */}}
{{ $relevantClusters := slice }}
{{ range $clusterName, $cluster := $topicClusters }}
  {{ $hasMatch := false }}
  {{ range $currentTags }}
    {{ if in $cluster.keywords (. | lower) }}
      {{ $hasMatch = true }}
    {{ end }}
  {{ end }}
  {{ if $hasMatch }}
    {{ $relevantClusters = $relevantClusters | append (dict "name" $clusterName "cluster" $cluster) }}
  {{ end }}
{{ end }}

{{ with $relevantClusters }}
<section class="contextual-links" style="margin: 3rem 0; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
  <h3 style="color: #333; margin-bottom: 1.5rem; font-size: 1.2em;">🔗 Explore Related Topics</h3>
  
  <div style="display: grid; gap: 1.5rem;">
    {{ range $cluster := . }}
      {{/* Find posts in this cluster */}}
      {{ $clusterPosts := slice }}
      {{ range $post := $blogPosts }}
        {{ $postTags := $post.Params.tags }}
        {{ range $postTags }}
          {{ if in $cluster.cluster.keywords (. | lower) }}
            {{ if ne $post.Permalink $.Permalink }}
              {{ $clusterPosts = $clusterPosts | append $post }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      {{ $uniquePosts := $clusterPosts | uniq }}
      {{ with first 4 $uniquePosts }}
      <div class="topic-cluster" style="border-left: 4px solid {{ $cluster.cluster.color }}; padding-left: 1rem;">
        <h4 style="color: {{ $cluster.cluster.color }}; margin: 0 0 0.75rem 0; font-size: 1.1em;">
          {{ $cluster.cluster.icon }} {{ $cluster.name }}
        </h4>
        <div style="display: grid; gap: 0.75rem;">
          {{ range . }}
          <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
            <span style="color: {{ $cluster.cluster.color }}; margin-top: 0.1rem; font-size: 0.8em;">▸</span>
            <div style="flex: 1;">
              <a href="{{ .RelPermalink }}" style="color: #0066cc; text-decoration: none; font-weight: 500; line-height: 1.3;">{{ .Title }}</a>
              {{ if .Summary }}
                <p style="color: #666; font-size: 0.85em; margin: 0.25rem 0 0 0; line-height: 1.3;">{{ .Summary | truncate 80 }}</p>
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
      </div>
      {{ end }}
    {{ end }}
  </div>
  
  {{/* Add call-to-action to browse by category */}}
  <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; text-align: center;">
    <a href="/blog/" style="background: #0066cc; color: white; padding: 0.5rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 500;">
      Browse All Articles
    </a>
  </div>
</section>
{{ end }}