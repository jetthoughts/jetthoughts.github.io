{{ $image := .image }}
{{ $title := .title }}
{{ $widths := .widths }}
{{ $attributes := .attributes | default "" }}

{{ $originalWidth := $image.Width }}
{{ $imageWebP := $image.Resize (printf "%dx webp q75" $originalWidth) }}
{{ $srcset := "" }}
{{ range $widths }}
{{ if lt . $originalWidth }}
{{ $resized := $image.Resize (printf "%dx webp q75" .) }}
{{ $srcset = printf "%s%s %dw, " $srcset $resized.RelPermalink . }}
{{ end }}
{{ end }}

<picture>
    {{ range $widths }}
    {{ if lt . $originalWidth }}
    {{ $resized := $image.Resize (printf "%dx webp q75" .) }}
    <source media="(max-width: {{ . }}px)" srcset="{{ $resized.RelPermalink }}">
    {{ end }}
    {{ end }}
    <img {{ $attributes }} src="{{ $imageWebP.RelPermalink }}" alt="{{ $title }}"
         width="{{ $image.Width }}" height="{{ $image.Height }}" title="{{ $title }}">
</picture>
