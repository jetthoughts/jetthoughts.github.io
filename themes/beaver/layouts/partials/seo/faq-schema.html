{{/* Enhanced FAQ Schema - JSON-LD structured data with deduplication support */}}
{{/* Prevent duplicate FAQ schema generation on the same page */}}
{{ if not (.Page.Scratch.Get "faq_schema_generated") }}
{{ .Page.Scratch.Set "faq_schema_generated" true }}

{{ $faqs := .Params.faqs }}
{{ if .Params.faq.questions }}
  {{ $faqs = .Params.faq.questions }}
{{ end }}

{{ if $faqs }}
{{/* Build FAQ array with duplicate question detection */}}
{{ $faqMainEntity := slice }}
{{ $processedQuestions := slice }}

{{ range $faqs }}
  {{/* Create a normalized question key for duplicate detection */}}
  {{ $normalizedQuestion := .question | lower | replaceRE "[^a-z0-9]+" "-" | replaceRE "^-+|-+$" "" }}

  {{/* Only add question if it hasn't been processed yet (prevents duplicates within page) */}}
  {{ if not (in $processedQuestions $normalizedQuestion) }}
    {{/* Create service-specific unique identifier for the question */}}
    {{ $uniqueId := printf "%s-%s" $.Params.slug $normalizedQuestion }}

    {{/* Build question object with unique identifier */}}
    {{ $questionObj := dict
      "@type" "Question"
      "@id" (printf "#faq-%s" $uniqueId)
      "name" .question
      "acceptedAnswer" (dict "@type" "Answer" "text" .answer)
    }}

    {{ $faqMainEntity = $faqMainEntity | append $questionObj }}
    {{ $processedQuestions = $processedQuestions | append $normalizedQuestion }}
  {{ end }}
{{ end }}

{{/* Only generate schema if we have unique FAQs */}}
{{ if gt (len $faqMainEntity) 0 }}
  {{ $faqSchema := dict
    "@context" "https://schema.org"
    "@type" "FAQPage"
    "mainEntity" $faqMainEntity
    "url" .Permalink
    "about" (dict
      "@type" "Service"
      "name" .Title
      "provider" (dict "@type" "Organization" "name" "JetThoughts")
    )
  }}

<script type="application/ld+json">
{{ $faqSchema | jsonify | safeJS }}
</script>
{{ end }}
{{ end }}

{{ end }}{{/* End of faq_schema_generated check */}}

{{/* Enhanced content-based FAQ detection for service pages */}}
{{ if and (eq .Section "services") (not .Params.faqs) (not .Params.faq.questions) }}
  {{/* Provide guidance for adding structured FAQ data */}}
  {{ $content := .Content | plainify }}
  {{ if or (strings.Contains $content "What is") (strings.Contains $content "How do") (strings.Contains $content "Why should") }}
    <!--
    FAQ patterns detected in content. Consider adding structured FAQ data to frontmatter:
    faqs:
      - question: "Your question here"
        answer: "Your answer here"
    -->
  {{ end }}
{{ end }}
