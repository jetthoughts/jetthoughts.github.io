{{/* Service Page Related Content with partialCached optimization
  Shows relevant blog posts and use cases for service pages */}}
{{ $servicePage := . }}
{{ $serviceSlug := .Params.slug }}
{{ $blogPosts := where .Site.RegularPages "Section" "blog" }}
{{ $useCases := where .Site.RegularPages "Section" "use-cases" }}

{{/* Create cache key from service slug + content hash */}}
{{ $contentHash := sha256 (jsonify (slice (len $blogPosts) (len $useCases) $serviceSlug)) }}
{{ $cacheKey := printf "related-content-%s" $contentHash }}

{{/* Use partialCached to cache the entire content generation */}}
{{ $contentData := dict "servicePage" $servicePage "serviceSlug" $serviceSlug "blogPosts" $blogPosts "useCases" $useCases }}
{{ partialCached "services/related-content-cached" $contentData $cacheKey }}

{{/* Define the cached partial */}}
{{ define "partials/services/related-content-cached" }}
{{ $servicePage := .servicePage }}
{{ $serviceSlug := .serviceSlug }}
{{ $blogPosts := .blogPosts }}
{{ $useCases := .useCases }}

{{/* Define service-to-content mappings */}}
{{ $contentMappings := dict
  "fractional-cto" (dict
    "keywords" (slice "cto" "leadership" "technical strategy" "startup" "management" "architecture" "scalability")
    "topics" (slice "Technology Leadership" "Startup Strategy" "Team Building" "Technical Architecture")
  )
  "app-web-development" (dict
    "keywords" (slice "development" "ruby" "rails" "react" "web" "app" "programming" "javascript" "typescript")
    "topics" (slice "Web Development" "Ruby on Rails" "React" "Full-Stack Development")
  )
  "outsourced-developer-staffing" (dict
    "keywords" (slice "hiring" "developers" "team" "staffing" "recruiting" "remote" "talent" "scaling")
    "topics" (slice "Team Scaling" "Remote Development" "Developer Hiring" "Talent Acquisition")
  )
  "software-qa-cat" (dict
    "keywords" (slice "testing" "qa" "quality" "automation" "performance" "security" "reliability")
    "topics" (slice "Software Testing" "Quality Assurance" "Test Automation" "Performance Testing")
  )
  "fractional-product-management" (dict
    "keywords" (slice "product" "roadmap" "features" "ux" "user" "strategy" "planning" "management")
    "topics" (slice "Product Strategy" "UX Design" "Product Management" "Feature Planning")
  )
}}

{{ $mapping := index $contentMappings $serviceSlug }}
{{ with $mapping }}

{{/* Find relevant blog posts */}}
{{ $relevantPosts := slice }}
{{ range $blogPosts }}
  {{ $score := 0 }}
  {{ $postTitle := .Title | lower }}
  {{ $postTags := .Params.tags }}

  {{/* Score based on title matches */}}
  {{ range $mapping.keywords }}
    {{ if in $postTitle . }}
      {{ $score = add $score 3 }}
    {{ end }}
  {{ end }}

  {{/* Score based on tag matches */}}
  {{ range $postTags }}
    {{ if in $mapping.keywords (. | lower) }}
      {{ $score = add $score 2 }}
    {{ end }}
  {{ end }}

  {{ if gt $score 1 }}
    {{ $relevantPosts = $relevantPosts | append (dict "post" . "score" $score) }}
  {{ end }}
{{ end }}

{{ $sortedPosts := sort $relevantPosts "score" "desc" }}
{{ $topPosts := first 6 $sortedPosts }}

{{ with $topPosts }}
<section class="service-related-content" style="margin: 4rem 0; padding: 3rem 2rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px;">
  <div style="text-align: center; margin-bottom: 3rem;">
    <h2 style="color: #333; margin-bottom: 1rem; font-size: 1.8em;">ðŸ“š Learn More About {{ $servicePage.Title }}</h2>
    <p style="color: #666; font-size: 1.1em; max-width: 600px; margin: 0 auto; line-height: 1.5;">
      Dive deeper into {{ $servicePage.Title | lower }} with insights from our team's experience and expertise.
    </p>
  </div>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; max-width: 1200px; margin: 0 auto;">
    {{ range . }}
      {{ $post := .post }}
      <article style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;"
               onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">

        {{ with $post.Params.cover_image }}
          <div style="margin-bottom: 1rem; border-radius: 6px; overflow: hidden;">
            <img src="{{ $post.RelPermalink }}{{ . }}"
                 alt="{{ $post.Title }}"
                 style="width: 100%; height: 150px; object-fit: cover;">
          </div>
        {{ end }}

        <div>
          <h3 style="margin: 0 0 0.75rem 0; font-size: 1.1em; line-height: 1.3;">
            <a href="{{ $post.RelPermalink }}" style="color: #0066cc; text-decoration: none;">{{ $post.Title }}</a>
          </h3>

          {{ with $post.Params.tags }}
            <div style="margin-bottom: 0.75rem;">
              {{ range first 3 . }}
                <span style="background: #e3f2fd; color: #1976d2; padding: 0.2em 0.5em; border-radius: 3px; font-size: 0.75em; margin-right: 0.3em;">#{{ . }}</span>
              {{ end }}
            </div>
          {{ end }}

          {{ if $post.Summary }}
            <p style="color: #666; font-size: 0.9em; line-height: 1.4; margin: 0 0 1rem 0;">{{ $post.Summary | truncate 120 }}...</p>
          {{ end }}

          <div style="display: flex; justify-content: between; align-items: center; margin-top: 1rem;">
            <a href="{{ $post.RelPermalink }}" style="color: #0066cc; text-decoration: none; font-weight: 500; font-size: 0.9em;">
              Read more â†’
            </a>
            {{ with $post.Params.created_at }}
              <span style="color: #999; font-size: 0.8em; margin-left: auto;">{{ dateFormat "Jan 2, 2006" . }}</span>
            {{ end }}
          </div>
        </div>
      </article>
    {{ end }}
  </div>

  {{/* Link to browse all related posts */}}
  {{ with index $mapping.keywords 0 }}
    <div style="text-align: center; margin-top: 3rem;">
      <a href="/blog/tags/{{ . | urlize }}/"
         style="background: #0066cc; color: white; padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-block; transition: background 0.3s ease;"
         onmouseover="this.style.background='#0052a3'"
         onmouseout="this.style.background='#0066cc'">
        View All {{ . | title }} Articles
      </a>
    </div>
  {{ end }}
</section>
{{ end }}

{{/* Add use cases section if available */}}
{{ $relevantUseCases := slice }}
{{ range $useCase := $useCases }}
  {{ $useCaseTitle := $useCase.Title | lower }}
  {{ range $keyword := $mapping.keywords }}
    {{ if in $useCaseTitle $keyword }}
      {{ $relevantUseCases = $relevantUseCases | append $useCase }}
    {{ end }}
  {{ end }}
{{ end }}

{{ with first 3 $relevantUseCases }}
<section style="margin: 3rem 0; padding: 2rem; background: #fff; border: 1px solid #e9ecef; border-radius: 8px;">
  <h3 style="color: #333; margin-bottom: 1.5rem; font-size: 1.3em;">ðŸŽ¯ Related Use Cases</h3>
  <div style="display: grid; gap: 1rem;">
    {{ range . }}
      <div style="border-left: 3px solid #0066cc; padding-left: 1rem;">
        <h4 style="margin: 0 0 0.5rem 0;">
          <a href="{{ .RelPermalink }}" style="color: #0066cc; text-decoration: none;">{{ .Title }}</a>
        </h4>
        {{ with .Summary }}
          <p style="color: #666; font-size: 0.9em; margin: 0; line-height: 1.4;">{{ . | truncate 100 }}</p>
        {{ end }}
      </div>
    {{ end }}
  </div>
</section>
{{ end }}

{{ end }}
{{ end }}